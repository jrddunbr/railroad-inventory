{% extends "base.html" %}
{% block content %}
  <div class="box">
    <h1 class="title is-3">Flat Packing: {{ location.name }}</h1>
    <div class="actions buttons">
      <a class="button is-small is-light" href="{{ url_for('main.location_detail', location_id=location.id) }}">Back to Location</a>
    </div>

    {% if errors %}
      <article class="message is-danger">
        <div class="message-body">
          <ul>
            {% for error in errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
      </article>
    {% endif %}

    {% if missing_length %}
      <article class="message is-warning">
        <div class="message-body">
          <p><strong>Missing actual length:</strong></p>
          <ul>
            {% for car in missing_length %}
              <li><a href="{{ url_for('main.car_detail', car_id=car.id) }}">{{ car.label }}</a></li>
            {% endfor %}
          </ul>
        </div>
      </article>
    {% endif %}

    {% if missing_flat_settings %}
      <article class="message is-warning">
        <div class="message-body">
          <p><strong>Flat settings required:</strong> Add flat length and row count in <a href="{{ url_for('main.location_edit', location_id=location.id) }}">Edit Location</a> before packing.</p>
        </div>
      </article>
    {% endif %}

    <form method="post" action="{{ url_for('main.flat_pack', location_id=location.id) }}" data-confirm-skip="true">
      <div class="box" style="margin-bottom: 16px;">
        <h2 class="title is-4">Packing Settings</h2>
        <div class="grid">
          <div class="field">
            <label class="label" for="packing_mode">Packing Mode</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select id="packing_mode" name="packing_mode">
                  <option value="frugal" {% if packing_mode == 'frugal' %}selected{% endif %}>Frugal (foam at each car end)</option>
                  <option value="fill" {% if packing_mode == 'fill' %}selected{% endif %}>Fill (car ends + leave small gap)</option>
                  <option value="dense" {% if packing_mode == 'dense' %}selected{% endif %}>Dense (car ends + compress to fill)</option>
                </select>
              </div>
            </div>
          </div>
          <div class="field">
            <label class="label">Compression</label>
            <div class="control">
              <label class="checkbox">
                <input id="compression_enabled" type="checkbox" name="compression_enabled" {% if compression_enabled %}checked{% endif %} />
                Enable compression when needed to fit cars
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="box" style="margin-bottom: 16px;">
        <h2 class="title is-4">Foam Sizes</h2>
        <article class="message is-info">
          <div class="message-body">
            <p><strong>Note:</strong> Foam length is used to pack cars linearly. Topmost selection is used at each car end; ordering sets priority for fill blocks.</p>
          </div>
        </article>
        {% if not foam_block_options %}
          <article class="message is-warning">
            <div class="message-body">
              <p>No foam blocks configured. Add sizes in <a href="{{ url_for('main.settings') }}">Settings</a>.</p>
            </div>
          </article>
        {% endif %}
        <div class="grid">
          <div class="field">
            <label class="label" for="foam_select">Available Blocks</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select id="foam_select">
                  {% for block in foam_block_options %}
                    <option value="{{ block.id }}">{{ block.label }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div class="field">
            <label class="label">Selected Blocks (Priority Order)</label>
            <div class="control">
              <table class="table is-fullwidth is-striped" id="foam-selected-table">
                <thead>
                  <tr>
                    <th>Priority</th>
                    <th>Block</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="actions buttons">
          <button type="button" class="button is-small is-light" id="foam-add">Add</button>
        </div>
        <div id="foam-hidden-inputs"></div>
      </div>

      <div class="box" style="margin-bottom: 16px;">
        <h2 class="title is-4">Cars Included</h2>
        <table class="table is-fullwidth is-striped">
          <thead>
            <tr>
              <th>Select</th>
              <th>Car</th>
              <th>Length</th>
            </tr>
          </thead>
          <tbody>
            {% for car in car_entries %}
              <tr>
                <td>
                  <label class="checkbox">
                    <input type="checkbox" name="car_ids" value="{{ car.id }}" {% if car.id in selected_ids %}checked{% endif %} />
                  </label>
                </td>
                <td><a href="{{ url_for('main.car_detail', car_id=car.id) }}">{{ car.label }}</a></td>
                <td>{{ car.length_display }}</td>
              </tr>
            {% else %}
              <tr>
                <td colspan="3">No cars found for this location.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="actions buttons">
        <button type="submit" class="button is-small is-primary" {% if missing_flat_settings %}disabled{% endif %}>Run Packing</button>
      </div>
    </form>

    {% if pack_result %}
      <hr />
      <h2 class="title is-4">Placement Diagram</h2>
      <p class="help">
        Foam blocks: {{ pack_result.total_foam_blocks }} |
        Foam length: {{ pack_result.total_foam_display }} {{ pack_result.flat_unit }} |
        Unfilled gap: {{ pack_result.total_gap_display }} {{ pack_result.flat_unit }}
      </p>
      <div class="box" style="margin-bottom: 16px;">
        <h3 class="title is-5">Printout Size</h3>
        <form method="post" action="{{ url_for('main.flat_pack_pdf', location_id=location.id) }}" data-confirm-skip="true">
          {% for car_id in selected_ids %}
            <input type="hidden" name="car_ids" value="{{ car_id }}" />
          {% endfor %}
          {% for foam_id in selected_foam_ids %}
            <input type="hidden" name="foam_block_ids" value="{{ foam_id }}" />
          {% endfor %}
          <input type="hidden" name="packing_mode" value="{{ packing_mode }}" />
          {% if compression_enabled %}
            <input type="hidden" name="compression_enabled" value="on" />
          {% endif %}
          <div class="grid">
            <div class="field">
              <label class="label" for="print_width_value">Width</label>
              <div class="control">
                <div class="field has-addons">
                  <div class="control is-expanded">
                    <input class="input" id="print_width_value" name="print_width_value" value="{{ print_width_value }}" />
                  </div>
                  <div class="control">
                    <div class="select">
                      <select id="print_width_unit" name="print_width_unit">
                        <option value="in" {% if print_width_unit == 'in' %}selected{% endif %}>in</option>
                        <option value="ft" {% if print_width_unit == 'ft' %}selected{% endif %}>ft</option>
                        <option value="mm" {% if print_width_unit == 'mm' %}selected{% endif %}>mm</option>
                        <option value="cm" {% if print_width_unit == 'cm' %}selected{% endif %}>cm</option>
                        <option value="m" {% if print_width_unit == 'm' %}selected{% endif %}>m</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label" for="print_height_value">Height</label>
              <div class="control">
                <div class="field has-addons">
                  <div class="control is-expanded">
                    <input class="input" id="print_height_value" name="print_height_value" value="{{ print_height_value }}" />
                  </div>
                  <div class="control">
                    <div class="select">
                      <select id="print_height_unit" name="print_height_unit">
                        <option value="in" {% if print_height_unit == 'in' %}selected{% endif %}>in</option>
                        <option value="ft" {% if print_height_unit == 'ft' %}selected{% endif %}>ft</option>
                        <option value="mm" {% if print_height_unit == 'mm' %}selected{% endif %}>mm</option>
                        <option value="cm" {% if print_height_unit == 'cm' %}selected{% endif %}>cm</option>
                        <option value="m" {% if print_height_unit == 'm' %}selected{% endif %}>m</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label">&nbsp;</label>
              <div class="control">
                <button type="submit" class="button is-small is-link">Export PDF</button>
              </div>
            </div>
            <div class="field">
              <label class="label">&nbsp;</label>
              <div class="control">
                <button type="submit" class="button is-small is-light" name="wireframe" value="1">Export Wireframe PDF</button>
              </div>
            </div>
          </div>
          <p class="help">Use the print size to fit the diagram on the box label.</p>
        </form>
      </div>
      <div class="flat-pack-diagram">
        {% for row in pack_result.rows %}
          <div class="flat-pack-row">
            <div class="flat-pack-row-label">Row {{ row.index }}</div>
              <div class="flat-pack-track">
                {% for segment in row.segments %}
                  <div class="flat-pack-segment flat-pack-{{ segment.type }}" style="flex: 0 0 {{ segment.width_percent }}%;{% if segment.color %} background: {{ segment.color }};{% endif %}">
                    {% if segment.width_percent >= 6 %}
                      {% if segment.type == 'car' %}
                        <span class="flat-pack-label"><strong>{{ segment.primary_label }}</strong>{% if segment.secondary_label %}<br /><span class="flat-pack-subtitle">{{ segment.secondary_label }}</span>{% endif %}</span>
                      {% else %}
                        <span class="flat-pack-label">{{ segment.label }}</span>
                      {% endif %}
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
        {% endfor %}
      </div>
      <div class="flat-pack-legend">
        <p class="help"><strong>Foam pieces:</strong> {{ pack_result.total_foam_blocks }}</p>
        {% if pack_result.foam_legend %}
          <div class="flat-pack-legend-items">
            {% for item in pack_result.foam_legend %}
              <div class="flat-pack-legend-item">
                <span class="flat-pack-legend-swatch" style="background: {{ item.color }};"></span>
                <span><strong>{{ item.length }}</strong>{% if item.width or item.height %} ({{ item.width }} x {{ item.height }}){% endif %}</span>
                <span class="flat-pack-legend-count">x{{ item.count }}</span>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
      <article class="message is-info" style="margin-top: 16px;">
        <div class="message-body">
          <p><strong>Debug JSON</strong></p>
          <pre style="white-space: pre-wrap; font-size: 0.75rem;">{{ pack_result | tojson(indent=2) }}</pre>
        </div>
      </article>
      {% if pack_result.unplaced %}
        <article class="message is-warning" style="margin-top: 16px;">
          <div class="message-body">
            <p><strong>Unplaced Cars (insufficient rows):</strong></p>
            <ul>
              {% for car in pack_result.unplaced %}
                <li>{{ car.label }}</li>
              {% endfor %}
            </ul>
          </div>
        </article>
      {% endif %}
    {% endif %}
  </div>
  <script>
    const missingFlatSettings = {{ 'true' if missing_flat_settings else 'false' }};
    if (missingFlatSettings) {
      alert('Flat length and row count are required. Update the location settings before packing.');
    }

    const foamOptions = {{ foam_block_options | tojson }};
    const selectedFoamIds = {{ selected_foam_ids | tojson }};
    const foamSelect = document.getElementById('foam_select');
    const foamAddButton = document.getElementById('foam-add');
    const foamTableBody = document.querySelector('#foam-selected-table tbody');
    const foamHiddenInputs = document.getElementById('foam-hidden-inputs');

    const renderSelectedFoam = (selected) => {
      if (!foamTableBody || !foamHiddenInputs) return;
      foamTableBody.innerHTML = '';
      foamHiddenInputs.innerHTML = '';
      selected.forEach((id, index) => {
        const block = foamOptions.find((item) => item.id === id);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${block ? block.label : '-'}</td>
          <td>
            <button type="button" class="button is-small is-light" data-action="up" data-index="${index}">Up</button>
            <button type="button" class="button is-small is-light" data-action="down" data-index="${index}">Down</button>
            <button type="button" class="button is-small is-danger is-light" data-action="remove" data-index="${index}">Remove</button>
          </td>
        `;
        foamTableBody.appendChild(row);
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'foam_block_ids';
        input.value = String(id);
        foamHiddenInputs.appendChild(input);
      });
    };

    const selected = [...selectedFoamIds];
    renderSelectedFoam(selected);

    if (foamAddButton && foamSelect) {
      foamAddButton.addEventListener('click', () => {
        const id = Number(foamSelect.value);
        if (!Number.isNaN(id)) {
          selected.push(id);
          renderSelectedFoam(selected);
        }
      });
    }

    if (foamTableBody) {
      foamTableBody.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button) return;
        const index = Number(button.dataset.index);
        if (Number.isNaN(index)) return;
        if (button.dataset.action === 'remove') {
          selected.splice(index, 1);
        } else if (button.dataset.action === 'up' && index > 0) {
          [selected[index - 1], selected[index]] = [selected[index], selected[index - 1]];
        } else if (button.dataset.action === 'down' && index < selected.length - 1) {
          [selected[index], selected[index + 1]] = [selected[index + 1], selected[index]];
        }
        renderSelectedFoam(selected);
      });
    }

  </script>
{% endblock %}
