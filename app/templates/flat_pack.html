{% extends "base.html" %}
{% block title %}
Flat Pack: {{ location.name }}
{% endblock %}
{% block content %}
  <div class="box">
    <h1 class="title is-3">Flat Packing: {{ location.name }}</h1>
    <div class="actions buttons">
      <a class="button is-small is-light" href="{{ url_for('main.location_detail', location_id=location.id) }}">Back to Location</a>
    </div>

    {% if errors %}
      <article class="message is-danger">
        <div class="message-body">
          <ul>
            {% for error in errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
      </article>
    {% endif %}

    {% if missing_length %}
      <article class="message is-warning">
        <div class="message-body">
          <p><strong>Missing actual length:</strong></p>
          <ul>
            {% for car in missing_length %}
              <li><a href="{{ url_for('main.car_detail', car_id=car.id) }}">{{ car.label }}</a></li>
            {% endfor %}
          </ul>
        </div>
      </article>
    {% endif %}

    {% if missing_flat_settings %}
      <article class="message is-warning">
        <div class="message-body">
          <p><strong>Flat settings required:</strong> Add flat length and row count in <a href="{{ url_for('main.location_edit', location_id=location.id) }}">Edit Location</a> before packing.</p>
        </div>
      </article>
    {% endif %}

    <form method="post" action="{{ url_for('main.flat_pack', location_id=location.id) }}" data-confirm-skip="true">
      <div class="box" style="margin-bottom: 16px;">
        <h2 class="title is-4">Packing Settings</h2>
        <div class="grid">
          <div class="field">
            <label class="label" for="packing_mode">Packing Mode</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select id="packing_mode" name="packing_mode">
                  <option value="frugal" {% if packing_mode == 'frugal' %}selected{% endif %}>Frugal (foam at each car end)</option>
                  <option value="fill" {% if packing_mode == 'fill' %}selected{% endif %}>Fill (car ends + leave small gap)</option>
                  <option value="dense" {% if packing_mode == 'dense' %}selected{% endif %}>Dense (car ends + compress to fill)</option>
                </select>
              </div>
            </div>
          </div>
          <div class="field">
            <label class="label">Compression</label>
            <div class="control">
              <label class="checkbox">
                <input id="compression_enabled" type="checkbox" name="compression_enabled" {% if compression_enabled %}checked{% endif %} />
                Enable compression when needed to fit cars
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="box" style="margin-bottom: 16px;">
        <h2 class="title is-4">Foam Sizes</h2>
        <article class="message is-info">
          <div class="message-body">
            <p><strong>Note:</strong> Foam length is used to pack cars linearly. Topmost selection is used at each car end; ordering sets priority for fill blocks.</p>
          </div>
        </article>
        {% if not foam_block_options %}
          <article class="message is-warning">
            <div class="message-body">
              <p>No foam blocks configured. Add sizes in <a href="{{ url_for('main.settings') }}">Settings</a>.</p>
            </div>
          </article>
        {% endif %}
        <div class="grid">
          <div class="field">
            <label class="label" for="foam_select">Available Blocks</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select id="foam_select">
                  {% for block in foam_block_options %}
                    <option value="{{ block.id }}">{{ block.label }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div class="field">
            <label class="label">Selected Blocks (Priority Order)</label>
            <div class="control">
              <table class="table is-fullwidth is-striped" id="foam-selected-table">
                <thead>
                  <tr>
                    <th>Priority</th>
                    <th>Block</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="actions buttons">
          <button type="button" class="button is-small is-light" id="foam-add">Add</button>
        </div>
        <div id="foam-hidden-inputs"></div>
      </div>

      <div class="box" style="margin-bottom: 16px;">
        <h2 class="title is-4">Cars Included</h2>
        <table class="table is-fullwidth is-striped">
          <thead>
            <tr>
              <th>Select</th>
              <th>Car</th>
              <th>Length</th>
            </tr>
          </thead>
          <tbody>
            {% for car in car_entries %}
              <tr>
                <td>
                  <label class="checkbox">
                    <input type="checkbox" name="car_ids" value="{{ car.id }}" {% if car.id in selected_ids %}checked{% endif %} />
                  </label>
                </td>
                <td><a href="{{ url_for('main.car_detail', car_id=car.id) }}">{{ car.label }}</a></td>
                <td>{{ car.length_display }}</td>
              </tr>
            {% else %}
              <tr>
                <td colspan="3">No cars found for this location.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="actions buttons">
        <button type="submit" class="button is-small is-primary" formaction="{{ url_for('main.flat_pack_view', location_id=location.id) }}" {% if missing_flat_settings %}disabled{% endif %}>Run Packing</button>
      </div>
    </form>
  </div>
  <script>
    const missingFlatSettings = {{ 'true' if missing_flat_settings else 'false' }};
    if (missingFlatSettings) {
      alert('Flat length and row count are required. Update the location settings before packing.');
    }

    const foamOptions = {{ foam_block_options | tojson }};
    const selectedFoamIds = {{ selected_foam_ids | tojson }};
    const foamSelect = document.getElementById('foam_select');
    const foamAddButton = document.getElementById('foam-add');
    const foamTableBody = document.querySelector('#foam-selected-table tbody');
    const foamHiddenInputs = document.getElementById('foam-hidden-inputs');

    const renderSelectedFoam = (selected) => {
      if (!foamTableBody || !foamHiddenInputs) return;
      foamTableBody.innerHTML = '';
      foamHiddenInputs.innerHTML = '';
      selected.forEach((id, index) => {
        const block = foamOptions.find((item) => item.id === id);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${block ? block.label : '-'}</td>
          <td>
            <button type="button" class="button is-small is-light" data-action="up" data-index="${index}">Up</button>
            <button type="button" class="button is-small is-light" data-action="down" data-index="${index}">Down</button>
            <button type="button" class="button is-small is-danger is-light" data-action="remove" data-index="${index}">Remove</button>
          </td>
        `;
        foamTableBody.appendChild(row);
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'foam_block_ids';
        input.value = String(id);
        foamHiddenInputs.appendChild(input);
      });
    };

    const selected = [...selectedFoamIds];
    renderSelectedFoam(selected);

    if (foamAddButton && foamSelect) {
      foamAddButton.addEventListener('click', () => {
        const id = Number(foamSelect.value);
        if (!Number.isNaN(id)) {
          selected.push(id);
          renderSelectedFoam(selected);
        }
      });
    }

    if (foamTableBody) {
      foamTableBody.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button) return;
        const index = Number(button.dataset.index);
        if (Number.isNaN(index)) return;
        if (button.dataset.action === 'remove') {
          selected.splice(index, 1);
        } else if (button.dataset.action === 'up' && index > 0) {
          [selected[index - 1], selected[index]] = [selected[index], selected[index - 1]];
        } else if (button.dataset.action === 'down' && index < selected.length - 1) {
          [selected[index], selected[index + 1]] = [selected[index + 1], selected[index]];
        }
        renderSelectedFoam(selected);
      });
    }

  </script>
{% endblock %}
