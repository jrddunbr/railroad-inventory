{% extends "base.html" %}
{% block title %}
Location: {{ location.name }}
{% endblock %}
{% block content %}
  <div class="box">
    <h1 class="title is-3">Location: {{ location.name }}</h1>
    <div class="actions buttons">
      <a class="button is-small is-info" href="{{ url_for('main.location_edit', location_id=location.id) }}">Edit</a>
      <a class="button is-small is-primary" href="{{ url_for('main.car_new', location=location.name) }}">Add Car</a>
      <a class="button is-small is-primary" href="{{ url_for('main.location_inspect', location_id=location.id) }}">Inspect Cars</a>
      <a class="button is-small is-link" href="{{ url_for('main.tool_new', location_id=location.id, next=url_for('main.location_detail', location_id=location.id)) }}">Add Tool</a>
      <a class="button is-small is-link" href="{{ url_for('main.part_new', location_id=location.id, next=url_for('main.location_detail', location_id=location.id)) }}">Add Parts</a>
      <a class="button is-small is-link" href="{{ url_for('main.location_inventory_pdf', location_id=location.id) }}">Inventory PDF</a>
      {% if location.location_type == "flat" or location.flat_length or location.flat_rows %}
        <a class="button is-small is-link" href="{{ url_for('main.flat_pack', location_id=location.id) }}">Pack Flat</a>
      {% endif %}
      <form method="post" action="{{ url_for('main.location_delete', location_id=location.id) }}" data-action="delete" data-table="locations" data-id="{{ location.id }}" data-id-field="id" data-entity-label="location {{ location.name }}">
        <button type="submit" class="button is-small is-danger">Delete</button>
      </form>
      <a class="button is-small is-light" href="{{ url_for('main.locations') }}">Back to Locations</a>
    </div>
    <p><strong>Type:</strong> {{ location.location_type }}</p>
    {% if location.parent %}
      <p><strong>Parent:</strong> <a href="{{ url_for('main.location_detail', location_id=location.parent.id) }}">{{ location.parent.name }}</a></p>
    {% endif %}
    {% if location.children %}
      <p><strong>Children:</strong>
        {% for child in location.children %}
          <a href="{{ url_for('main.location_detail', location_id=child.id) }}">{{ child.name }}</a>{% if not loop.last %}, {% endif %}
        {% endfor %}
      </p>
    {% endif %}
    {% if location.external_length or location.external_width or location.external_height or location.external_weight %}
      <h3 class="title is-5">External Dimensions</h3>
      {% if location.external_length %}
        <p><strong>Length:</strong> {{ location.external_length }}</p>
      {% endif %}
      {% if location.external_width %}
        <p><strong>Width:</strong> {{ location.external_width }}</p>
      {% endif %}
      {% if location.external_height %}
        <p><strong>Height:</strong> {{ location.external_height }}</p>
      {% endif %}
      {% if location.external_weight %}
        <p><strong>Weight (Empty):</strong> {{ location.external_weight }}</p>
      {% endif %}
    {% endif %}
    {% if location.flat_length or location.flat_rows or location.flat_scale or location.flat_gauge or location.flat_height or location.flat_row_width or location.flat_weight %}
      <h3 class="title is-5">Flat Packing Details</h3>
      {% if location.flat_length %}
        <p><strong>Flat Length:</strong> {{ location.flat_length }}</p>
      {% endif %}
      {% if location.flat_rows %}
        <p><strong>Rows:</strong> {{ location.flat_rows }}</p>
      {% endif %}
      {% if location.flat_row_width %}
        <p><strong>Row Width:</strong> {{ location.flat_row_width }}</p>
      {% endif %}
      {% if location.flat_height %}
        <p><strong>Flat Height:</strong> {{ location.flat_height }}</p>
      {% endif %}
      {% if location.flat_weight %}
        <p><strong>Flat Weight (Empty):</strong> {{ location.flat_weight }}</p>
      {% endif %}
      {% if location.flat_scale %}
        <p><strong>Scale:</strong> {{ location.flat_scale }}</p>
      {% endif %}
      {% if location.flat_gauge %}
        <p><strong>Gauge:</strong> {{ location.flat_gauge }}</p>
      {% endif %}
    {% endif %}
    <h3 class="title is-5">Cars</h3>
    <p class="keyboard-hint">Results: {{ cars_pagination.total }}</p>
    <table class="table is-fullwidth is-striped">
      <thead>
        <tr>
          <th>ID</th>
          <th>Reporting Mark</th>
          <th>Car #</th>
          <th>Type</th>
          <th>Class</th>
        </tr>
      </thead>
      <tbody>
        {% for car in cars %}
        <tr>
          <td><a href="{{ url_for('main.car_detail', car_id=car.id) }}">{{ car.id }}</a></td>
          <td>
            {% if car.railroad %}
              <a href="{{ url_for('main.railroad_detail', railroad_id=car.railroad.id) }}">{{ car.railroad.reporting_mark or "-" }}</a>
            {% else %}
              {{ car.reporting_mark_override or "-" }}
            {% endif %}
          </td>
          <td>
            {% if car.car_number %}
              <span class="icon-text">
                <a href="{{ url_for('main.car_by_number', number=car.car_number) }}">{{ car.car_number }}</a>
                {% if car.repairs_required %}
                  <span class="icon">
                    <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                      <path fill="#4a4a4a" d="M21 6.6l-2.4 2.4-2.6-.3-.3-2.6L18 3.7A6.3 6.3 0 0011.2 12l-6.4 6.4a2.1 2.1 0 003 3l6.4-6.4A6.3 6.3 0 0021 6.6z"/>
                    </svg>
                  </span>
                {% endif %}
              </span>
            {% else %}
              {% if car.repairs_required %}
                <span class="icon-text">
                  <span>-</span>
                  <span class="icon">
                    <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                      <path fill="#4a4a4a" d="M21 6.6l-2.4 2.4-2.6-.3-.3-2.6L18 3.7A6.3 6.3 0 0011.2 12l-6.4 6.4a2.1 2.1 0 003 3l6.4-6.4A6.3 6.3 0 0021 6.6z"/>
                    </svg>
                  </span>
                </span>
              {% else %}
                -
              {% endif %}
            {% endif %}
          </td>
          <td>{{ car.car_type_override or (car.car_class.car_type if car.car_class else "-") }}</td>
          <td>
            {% if car.car_class %}
              <a href="{{ url_for('main.car_class_detail', class_id=car.car_class.id) }}">{{ car.car_class.code }}</a>
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5">No cars in this location yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <h3 class="title is-5">Loads</h3>
    <div class="actions buttons">
      <a class="button is-small is-primary" href="{{ url_for('main.load_placement_new_generic', location_id=location.id) }}">Add Load</a>
    </div>
    <table class="table is-fullwidth is-striped">
      <thead>
        <tr>
          <th>Load</th>
          <th>Quantity</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for placement in location.load_placements %}
        <tr>
          <td><a href="{{ url_for('main.load_detail', load_id=placement.load.id) }}">{{ placement.load.name }}</a></td>
          <td>{{ placement.quantity }}</td>
          <td>
            <a class="button is-small is-light" href="{{ url_for('main.load_placement_edit', placement_id=placement.id) }}">Move/Edit</a>
            <form method="post" action="{{ url_for('main.load_placement_delete', placement_id=placement.id) }}" data-action="delete" data-table="load_placements" data-id="{{ placement.id }}" data-id-field="id" data-entity-label="placement {{ placement.id }}" style="display: inline;">
              <button type="submit" class="button is-small is-danger">Delete</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="3">No loads stored here.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <h3 class="title is-5">Tools</h3>
    <table class="table is-fullwidth is-striped">
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
          <th>Brand</th>
          <th>Quantity</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for tool in tools %}
        <tr>
          <td>{{ tool.name or "-" }}</td>
          <td>{{ tool.description or "-" }}</td>
          <td>{{ tool.brand or "-" }}</td>
          <td>{{ tool.quantity if tool.quantity is not none else "-" }}</td>
          <td>
            <a class="button is-small is-light" href="{{ url_for('main.tool_edit', tool_id=tool.id, next=url_for('main.location_detail', location_id=location.id)) }}">Edit</a>
            <form method="post" action="{{ url_for('main.tool_delete', tool_id=tool.id, next=url_for('main.location_detail', location_id=location.id)) }}" data-action="delete" data-table="tool_items" data-id="{{ tool.id }}" data-id-field="id" data-entity-label="tool {{ tool.name or tool.id }}" style="display: inline;">
              <button type="submit" class="button is-small is-danger">Delete</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5">No tools stored here.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <h3 class="title is-5">Parts</h3>
    <table class="table is-fullwidth is-striped">
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
          <th>Brand</th>
          <th>UPC</th>
          <th>Quantity</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for part in parts %}
        <tr>
          <td>{{ part.name or "-" }}</td>
          <td>{{ part.description or "-" }}</td>
          <td>{{ part.brand or "-" }}</td>
          <td>{{ part.upc or "-" }}</td>
          <td>{{ part.quantity if part.quantity is not none else "-" }}</td>
          <td>
            <a class="button is-small is-light" href="{{ url_for('main.part_edit', part_id=part.id, next=url_for('main.location_detail', location_id=location.id)) }}">Edit</a>
            <form method="post" action="{{ url_for('main.part_delete', part_id=part.id, next=url_for('main.location_detail', location_id=location.id)) }}" data-action="delete" data-table="part_items" data-id="{{ part.id }}" data-id-field="id" data-entity-label="part {{ part.name or part.id }}" style="display: inline;">
              <button type="submit" class="button is-small is-danger">Delete</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6">No parts stored here.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if cars_pagination %}
      <div class="pagination">
        <div class="pagination-info">
          {% if cars_pagination.total %}
            Showing {{ cars_pagination.start }}-{{ cars_pagination.end }} of {{ cars_pagination.total }}
          {% else %}
            No results.
          {% endif %}
        </div>
        {% if cars_pagination.pages > 1 %}
          <div class="pagination-controls">
            {% if cars_pagination.prev_url %}
              <a class="button is-small is-light" href="{{ cars_pagination.prev_url }}">Prev</a>
            {% else %}
              <span class="button is-small is-static">Prev</span>
            {% endif %}
            <span class="pagination-label">Page {{ cars_pagination.page }} of {{ cars_pagination.pages }}</span>
            {% if cars_pagination.next_url %}
              <a class="button is-small is-light" href="{{ cars_pagination.next_url }}">Next</a>
            {% else %}
              <span class="button is-small is-static">Next</span>
            {% endif %}
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>
{% endblock %}
