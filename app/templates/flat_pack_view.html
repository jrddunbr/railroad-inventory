{% extends "base.html" %}
{% block content %}
  <div class="box">
    <h1 class="title is-3">Placement Diagram: {{ location.name }}</h1>
    <div class="actions buttons">
      <a class="button is-small is-light" href="{{ url_for('main.flat_pack', location_id=location.id) }}">Back to Packing</a>
    </div>

    {% if errors %}
      <article class="message is-danger">
        <div class="message-body">
          <ul>
            {% for error in errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
      </article>
    {% endif %}

    {% if pack_result %}
      <p class="help">
        Foam blocks: {{ pack_result.total_foam_blocks }} |
        Foam length: {{ pack_result.total_foam_display }} {{ pack_result.flat_unit }} |
        Unfilled gap: {{ pack_result.total_gap_display }} {{ pack_result.flat_unit }}
      </p>
      <div class="box" style="margin-bottom: 16px;">
        <h2 class="title is-4">Printout Size</h2>
        <form method="post" action="{{ url_for('main.flat_pack_pdf', location_id=location.id) }}" data-confirm-skip="true">
          {% for car_id in selected_ids %}
            <input type="hidden" name="car_ids" value="{{ car_id }}" />
          {% endfor %}
          {% for foam_id in selected_foam_ids %}
            <input type="hidden" name="foam_block_ids" value="{{ foam_id }}" />
          {% endfor %}
          <input type="hidden" name="packing_mode" value="{{ packing_mode }}" />
          {% if compression_enabled %}
            <input type="hidden" name="compression_enabled" value="on" />
          {% endif %}
          <div class="grid">
            <div class="field">
              <label class="label" for="print_width_value">Width</label>
              <div class="control">
                <div class="field has-addons">
                  <div class="control is-expanded">
                    <input class="input" id="print_width_value" name="print_width_value" value="{{ print_width_value }}" />
                  </div>
                  <div class="control">
                    <div class="select">
                      <select id="print_width_unit" name="print_width_unit">
                        <option value="in" {% if print_width_unit == 'in' %}selected{% endif %}>in</option>
                        <option value="ft" {% if print_width_unit == 'ft' %}selected{% endif %}>ft</option>
                        <option value="mm" {% if print_width_unit == 'mm' %}selected{% endif %}>mm</option>
                        <option value="cm" {% if print_width_unit == 'cm' %}selected{% endif %}>cm</option>
                        <option value="m" {% if print_width_unit == 'm' %}selected{% endif %}>m</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label" for="print_height_value">Height</label>
              <div class="control">
                <div class="field has-addons">
                  <div class="control is-expanded">
                    <input class="input" id="print_height_value" name="print_height_value" value="{{ print_height_value }}" />
                  </div>
                  <div class="control">
                    <div class="select">
                      <select id="print_height_unit" name="print_height_unit">
                        <option value="in" {% if print_height_unit == 'in' %}selected{% endif %}>in</option>
                        <option value="ft" {% if print_height_unit == 'ft' %}selected{% endif %}>ft</option>
                        <option value="mm" {% if print_height_unit == 'mm' %}selected{% endif %}>mm</option>
                        <option value="cm" {% if print_height_unit == 'cm' %}selected{% endif %}>cm</option>
                        <option value="m" {% if print_height_unit == 'm' %}selected{% endif %}>m</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label">&nbsp;</label>
              <div class="control">
                <button type="submit" class="button is-small is-link">Export PDF</button>
              </div>
            </div>
            <div class="field">
              <label class="label">&nbsp;</label>
              <div class="control">
                <button type="submit" class="button is-small is-light" name="wireframe" value="1">Export Wireframe PDF</button>
              </div>
            </div>
          </div>
          <p class="help">Use the print size to fit the diagram on the box label.</p>
        </form>
      </div>
      <div class="flat-pack-diagram">
        {% for row in pack_result.rows %}
          <div class="flat-pack-row">
            <div class="flat-pack-row-label">Row {{ row.index }}</div>
              <div class="flat-pack-track">
                {% for segment in row.segments %}
                  <div class="flat-pack-segment flat-pack-{{ segment.type }}" style="flex: 0 0 {{ segment.width_percent }}%;{% if segment.color %} background: {{ segment.color }};{% endif %}">
                    {% if segment.width_percent >= 6 %}
                      {% if segment.type == 'car' %}
                        <span class="flat-pack-label"><strong>{{ segment.primary_label }}</strong>{% if segment.secondary_label %}<br /><span class="flat-pack-subtitle">{{ segment.secondary_label }}</span>{% endif %}</span>
                      {% else %}
                        <span class="flat-pack-label">{{ segment.label }}</span>
                      {% endif %}
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
        {% endfor %}
      </div>
      <div class="flat-pack-legend">
        <p class="help"><strong>Foam pieces:</strong> {{ pack_result.total_foam_blocks }}</p>
        {% if pack_result.foam_legend %}
          <div class="flat-pack-legend-items">
            {% for item in pack_result.foam_legend %}
              <div class="flat-pack-legend-item">
                <span class="flat-pack-legend-swatch" style="background: {{ item.color }};"></span>
                <span><strong>{{ item.length }}</strong>{% if item.width or item.height %} ({{ item.width }} x {{ item.height }}){% endif %}</span>
                <span class="flat-pack-legend-count">x{{ item.count }}</span>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
      <article class="message is-info" style="margin-top: 16px;">
        <div class="message-body">
          <p><strong>Debug JSON</strong></p>
          <pre style="white-space: pre-wrap; font-size: 0.75rem;">{{ pack_result | tojson(indent=2) }}</pre>
        </div>
      </article>
      {% if pack_result.unplaced %}
        <article class="message is-warning" style="margin-top: 16px;">
          <div class="message-body">
            <p><strong>Unplaced Cars (insufficient rows):</strong></p>
            <ul>
              {% for car in pack_result.unplaced %}
                <li>{{ car.label }}</li>
              {% endfor %}
            </ul>
          </div>
        </article>
      {% endif %}
    {% endif %}
  </div>

  <style>
    .flat-pack-diagram {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
    }
    .flat-pack-row {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }
    .flat-pack-row-label {
      width: 72px;
      font-weight: 600;
    }
    .flat-pack-track {
      flex: 1;
      display: flex;
      border: 1px solid #d0d0d0;
      min-height: 48px;
      background: #f9f9f9;
      min-width: 0;
    }
    .flat-pack-segment {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      color: #1d1d1d;
      padding: 4px;
      border-right: 1px solid #ffffff;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 0;
    }
    .flat-pack-label {
      display: inline-block;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .flat-pack-subtitle {
      font-weight: 500;
      font-size: 0.7rem;
      display: block;
    }
    .flat-pack-segment:last-child {
      border-right: none;
    }
    .flat-pack-car {
      background: #9db4d6;
    }
    .flat-pack-foam {
      background: #e7c39b;
    }
    .flat-pack-gap {
      background: #d9d9d9;
    }
    .flat-pack-legend {
      margin-top: 16px;
    }
    .flat-pack-legend-items {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 6px;
    }
    .flat-pack-legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: #fafafa;
      font-size: 0.85rem;
    }
    .flat-pack-legend-swatch {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      display: inline-block;
    }
    .flat-pack-legend-count {
      font-weight: 600;
    }
  </style>
{% endblock %}
