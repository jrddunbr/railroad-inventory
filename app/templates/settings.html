{% extends "base.html" %}
{% block content %}
  <div class="box">
    <h1 class="title is-3">Settings</h1>
    <h2 class="title is-4">Table Pagination</h2>
    <form method="post" action="{{ url_for('main.settings_pagination') }}" data-table="app_settings" data-id="1" data-id-field="id" data-entity-label="pagination settings">
      <label class="label" for="page_size">Rows per page</label>
      <div class="control">
        <div class="select is-fullwidth">
          <select name="page_size" id="page_size">
            {% for option in page_size_options %}
              <option value="{{ option.value }}" {% if option.value == page_size %}selected{% endif %}>{{ option.label }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="actions buttons">
        <button type="submit" class="button is-small is-primary is-light">Save Pagination</button>
      </div>
    </form>
    <h2 class="title is-4">Default Measurement Units</h2>
    <form method="post" action="{{ url_for('main.settings_units') }}" data-table="app_settings" data-id="1" data-id-field="id" data-entity-label="default measurement units">
      <div class="grid">
        <div class="field">
          <label class="label" for="default_length_unit">Length</label>
          <div class="control">
            <div class="select is-fullwidth">
              <select name="default_length_unit" id="default_length_unit">
                {% for unit in length_units %}
                  <option value="{{ unit }}" {% if unit == default_length_unit %}selected{% endif %}>{{ unit }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="field">
          <label class="label" for="default_weight_unit">Weight</label>
          <div class="control">
            <div class="select is-fullwidth">
              <select name="default_weight_unit" id="default_weight_unit">
                {% for unit in weight_units %}
                  <option value="{{ unit }}" {% if unit == default_weight_unit %}selected{% endif %}>{{ unit }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="actions buttons">
        <button type="submit" class="button is-small is-primary is-light">Save Units</button>
      </div>
    </form>
    <h2 class="title is-4">Scale &amp; Gauge Options</h2>
    <p class="keyboard-hint">One option per line. Use `Scale|Ratio` (example: `HO|1:87`) and `Gauge|Scales` (example: `16.5 mm|HO, HOn3`).</p>
    <form method="post" action="{{ url_for('main.settings_scale_gauge') }}" data-table="app_settings" data-id="1" data-id-field="id" data-entity-label="scale and gauge settings">
      <div class="grid">
        <div class="field">
          <label class="label" for="scale_options">Scale Options</label>
          <div class="control">
            <textarea class="textarea" id="scale_options" name="scale_options" rows="10">{{ scale_options_text }}</textarea>
          </div>
        </div>
        <div class="field">
          <label class="label" for="gauge_options">Gauge Options</label>
          <div class="control">
            <textarea class="textarea" id="gauge_options" name="gauge_options" rows="10">{{ gauge_options_text }}</textarea>
          </div>
        </div>
      </div>
      <div class="actions buttons">
        <button type="submit" class="button is-small is-primary is-light">Save Scale &amp; Gauge</button>
      </div>
    </form>
    <h2 class="title is-4">Foam Block Sizes</h2>
    <article class="message is-info">
      <div class="message-body">
        <p><strong>Note:</strong> Foam length is used to pack cars linearly. Compression is the amount the foam can be crushed.</p>
      </div>
    </article>
    <form method="post" action="{{ url_for('main.settings_foam_blocks') }}" data-table="app_settings" data-id="1" data-id-field="id" data-entity-label="foam block settings">
      <input type="hidden" id="foam_blocks" name="foam_blocks" value="{{ foam_blocks_text | e }}" data-confirm-include="true" data-confirm-label="Foam Blocks" />
      <div class="grid">
        <div class="field">
          <label class="label" for="foam_length_value">Length</label>
          <div class="control">
            <div class="field has-addons">
              <div class="control is-expanded">
                <input class="input" id="foam_length_value" placeholder="Length" />
              </div>
              <div class="control">
                <div class="select">
                  <select id="foam_length_unit">
                    {% for unit in length_units %}
                      <option value="{{ unit }}" {% if unit == default_length_unit %}selected{% endif %}>{{ unit }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="field">
          <label class="label" for="foam_width_value">Width</label>
          <div class="control">
            <div class="field has-addons">
              <div class="control is-expanded">
                <input class="input" id="foam_width_value" placeholder="Width" />
              </div>
              <div class="control">
                <div class="select">
                  <select id="foam_width_unit">
                    {% for unit in length_units %}
                      <option value="{{ unit }}" {% if unit == default_length_unit %}selected{% endif %}>{{ unit }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="field">
          <label class="label" for="foam_height_value">Height</label>
          <div class="control">
            <div class="field has-addons">
              <div class="control is-expanded">
                <input class="input" id="foam_height_value" placeholder="Height" />
              </div>
              <div class="control">
                <div class="select">
                  <select id="foam_height_unit">
                    {% for unit in length_units %}
                      <option value="{{ unit }}" {% if unit == default_length_unit %}selected{% endif %}>{{ unit }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="field">
          <label class="label" for="foam_weight_value">Weight</label>
          <div class="control">
            <div class="field has-addons">
              <div class="control is-expanded">
                <input class="input" id="foam_weight_value" placeholder="Weight" />
              </div>
              <div class="control">
                <div class="select">
                  <select id="foam_weight_unit">
                    {% for unit in weight_units %}
                      <option value="{{ unit }}" {% if unit == default_weight_unit %}selected{% endif %}>{{ unit }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="field">
          <label class="label" for="foam_compression_value">Compression</label>
          <div class="control">
            <div class="field has-addons">
              <div class="control is-expanded">
                <input class="input" id="foam_compression_value" placeholder="Compression" />
              </div>
              <div class="control">
                <div class="select">
                  <select id="foam_compression_unit">
                    {% for unit in length_units %}
                      <option value="{{ unit }}" {% if unit == default_length_unit %}selected{% endif %}>{{ unit }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="actions buttons">
        <button type="button" class="button is-small is-light" id="foam-add">Add Block</button>
      </div>
      <table class="table is-fullwidth is-striped" id="foam-table">
        <thead>
          <tr>
            <th>Length</th>
            <th>Width</th>
            <th>Height</th>
            <th>Weight</th>
            <th>Compression</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </form>
    <h2 class="title is-4">Inspection Types</h2>
    <p class="keyboard-hint">Types: {{ inspection_types|length }}</p>
    <div class="actions buttons">
      <a class="button is-small is-primary" href="{{ url_for('main.inspection_type_new') }}">Add Inspection Type</a>
    </div>
    <table class="table is-fullwidth is-striped">
      <thead>
        <tr>
          <th>Name</th>
          <th>Parent</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for row in inspection_types %}
        <tr>
          <td>{{ row.label }}</td>
          <td>{{ row.type.parent.name if row.type.parent else "-" }}</td>
          <td>
            <a class="button is-small is-info" href="{{ url_for('main.inspection_type_edit', type_id=row.type.id) }}">Edit</a>
            <form method="post" action="{{ url_for('main.inspection_type_delete', type_id=row.type.id) }}" data-action="delete" data-table="inspection_types" data-id="{{ row.type.id }}" data-id-field="id" data-entity-label="inspection type {{ row.type.id }}" style="display: inline;">
              <button type="submit" class="button is-small is-danger">Delete</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="3">No inspection types yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <script>
    const foamBlocksInput = document.getElementById('foam_blocks');
    const foamTableBody = document.querySelector('#foam-table tbody');
    const foamAddButton = document.getElementById('foam-add');
    const foamFields = {
      lengthValue: document.getElementById('foam_length_value'),
      lengthUnit: document.getElementById('foam_length_unit'),
      widthValue: document.getElementById('foam_width_value'),
      widthUnit: document.getElementById('foam_width_unit'),
      heightValue: document.getElementById('foam_height_value'),
      heightUnit: document.getElementById('foam_height_unit'),
      weightValue: document.getElementById('foam_weight_value'),
      weightUnit: document.getElementById('foam_weight_unit'),
      compressionValue: document.getElementById('foam_compression_value'),
      compressionUnit: document.getElementById('foam_compression_unit'),
    };

    const parseFoamBlocks = () => {
      if (!foamBlocksInput || !foamBlocksInput.value) return [];
      try {
        const parsed = JSON.parse(foamBlocksInput.value);
        return Array.isArray(parsed) ? parsed : [];
      } catch (error) {
        return [];
      }
    };

    const serializeFoamBlocks = (blocks) => {
      if (!foamBlocksInput) return;
      foamBlocksInput.value = JSON.stringify(blocks);
    };

    const renderFoamBlocks = (blocks) => {
      if (!foamTableBody) return;
      foamTableBody.innerHTML = '';
      blocks.forEach((block, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${block.length || '-'}</td>
          <td>${block.width || '-'}</td>
          <td>${block.height || '-'}</td>
          <td>${block.weight || '-'}</td>
          <td>${block.compression || '-'}</td>
          <td>
            <button type="button" class="button is-small is-danger is-light" data-action="remove" data-index="${index}">Remove</button>
          </td>
        `;
        foamTableBody.appendChild(row);
      });
    };

    const getFoamBlocks = () => {
      return parseFoamBlocks();
    };

    const setFoamBlocks = (blocks) => {
      serializeFoamBlocks(blocks);
      renderFoamBlocks(blocks);
    };

    const buildValue = (value, unit) => {
      if (!value) return '';
      return `${value} ${unit}`.trim();
    };

    const clearFoamInputs = () => {
      Object.values(foamFields).forEach((field) => {
        if (!field) return;
        if (field.tagName === 'SELECT') return;
        field.value = '';
      });
    };

    if (foamAddButton) {
      foamAddButton.addEventListener('click', () => {
        const lengthValue = foamFields.lengthValue.value.trim();
        const widthValue = foamFields.widthValue.value.trim();
        const heightValue = foamFields.heightValue.value.trim();
        const weightValue = foamFields.weightValue.value.trim();
        const compressionValue = foamFields.compressionValue.value.trim();
        if (!lengthValue) return;
        const block = {
          length: buildValue(lengthValue, foamFields.lengthUnit.value),
          width: buildValue(widthValue, foamFields.widthUnit.value),
          height: buildValue(heightValue, foamFields.heightUnit.value),
          weight: buildValue(weightValue, foamFields.weightUnit.value),
          compression: buildValue(compressionValue, foamFields.compressionUnit.value),
        };
        const blocks = getFoamBlocks();
        blocks.push(block);
        setFoamBlocks(blocks);
        clearFoamInputs();
        const form = foamAddButton.closest('form');
        if (form) {
          if (form.requestSubmit) {
            form.requestSubmit();
          } else {
            form.submit();
          }
        }
      });
    }

    if (foamTableBody) {
      foamTableBody.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button) return;
        const action = button.dataset.action;
        const index = Number(button.dataset.index);
        const blocks = getFoamBlocks();
        if (Number.isNaN(index) || index < 0 || index >= blocks.length) return;
        if (action === 'remove') {
          blocks.splice(index, 1);
        }
        setFoamBlocks(blocks);
        const form = foamTableBody.closest('form');
        if (form) {
          if (form.requestSubmit) {
            form.requestSubmit();
          } else {
            form.submit();
          }
        }
      });
    }

    setFoamBlocks(parseFoamBlocks());
  </script>
{% endblock %}
