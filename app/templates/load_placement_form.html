{% extends "base.html" %}
{% block content %}
  <div class="box">
    <h1 class="title is-3">{{ "Edit Placement" if placement else "New Placement" }}</h1>
    <form method="post" action="{{ url_for('main.load_placement_edit', placement_id=placement.id) if placement else (url_for('main.load_placement_new', load_id=load.id) if load else url_for('main.load_placement_new_generic')) }}" data-table="load_placements" data-id="{{ placement.id if placement else '' }}" data-id-field="id">
      <div class="grid">
        {% if load %}
          <div class="field">
            <label class="label">Load</label>
            <div class="control">
              <p>{{ load.name }}</p>
            </div>
          </div>
        {% else %}
          <div class="field">
            <label class="label" for="load_id">Load</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select id="load_id" name="load_id" required>
                  <option value="">-</option>
                  {% for load_item in loads %}
                    <option value="{{ load_item.id }}">{{ load_item.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
        {% endif %}
        <div class="field">
          <label class="label" for="quantity">Quantity</label>
          <div class="control">
            <input class="input" id="quantity" name="quantity" value="{{ placement.quantity if placement else 1 }}" />
          </div>
        </div>
        <div class="field">
          <label class="label">Placement Target</label>
          <div class="control">
            <label class="radio">
              <input type="radio" name="placement_target" value="car" {% if preset_car_id %}checked{% endif %} />
              Car
            </label>
            <label class="radio">
              <input type="radio" name="placement_target" value="location" {% if preset_location_id and not preset_car_id %}checked{% endif %} />
              Location
            </label>
          </div>
          <p class="help">Choose either a car or a location.</p>
        </div>
        <div class="field" id="car-target">
          <label class="label" for="car_lookup">Car</label>
          <div class="control">
            {% set selected_label = namespace(value="") %}
            <input type="hidden" id="car_id" name="car_id" value="{{ preset_car_id }}" />
            <datalist id="car_options">
              {% for car in cars %}
                {% set car_label = (car.railroad.reporting_mark if car.railroad else (car.reporting_mark_override or "")) ~ " " ~ (car.car_number or "") %}
                {% set display_label = car_label.strip() or ("Car " ~ car.id) %}
                {% if preset_car_id and preset_car_id == car.id|string %}
                  {% set selected_label.value = display_label %}
                {% endif %}
                <option value="{{ display_label }}" data-id="{{ car.id }}"></option>
              {% endfor %}
            </datalist>
            <input class="input" id="car_lookup" name="car_lookup" list="car_options" value="{{ selected_label.value }}" placeholder="Reporting mark + car number" />
          </div>
        </div>
        <div class="field" id="location-target">
          <label class="label" for="location_id">Location</label>
          <div class="control">
            <div class="select is-fullwidth">
              <select id="location_id" name="location_id">
                <option value="">-</option>
                {% for location in locations %}
                  <option value="{{ location.id }}" {% if preset_location_id and preset_location_id == location.id|string %}selected{% endif %}>{{ location.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="actions buttons">
        <button type="submit" class="button is-small is-primary">Save</button>
        {% if load %}
          <a class="button is-small is-light" href="{{ url_for('main.load_detail', load_id=load.id) }}">Cancel</a>
        {% else %}
          <a class="button is-small is-light" href="{{ url_for('main.loads') }}">Cancel</a>
        {% endif %}
      </div>
    </form>
  </div>
  <script>
    const targetRadios = Array.from(document.querySelectorAll('input[name="placement_target"]'));
    const carTarget = document.getElementById('car-target');
    const locationTarget = document.getElementById('location-target');
    const carIdInput = document.getElementById('car_id');
    const carLookup = document.getElementById('car_lookup');
    const carOptions = document.getElementById('car_options');
    const locationSelect = document.getElementById('location_id');

    const updateCarId = () => {
      if (!carLookup || !carIdInput || !carOptions) return;
      const value = carLookup.value.trim();
      if (!value) {
        carIdInput.value = '';
        return;
      }
      const option = Array.from(carOptions.options).find((item) => item.value === value);
      carIdInput.value = option ? option.dataset.id || '' : '';
    };

    const setTarget = (value) => {
      if (!value) {
        carTarget.style.display = '';
        locationTarget.style.display = '';
        return;
      }
      if (value === 'car') {
        carTarget.style.display = '';
        locationTarget.style.display = 'none';
        if (locationSelect) locationSelect.value = '';
      } else {
        carTarget.style.display = 'none';
        locationTarget.style.display = '';
        if (carLookup) carLookup.value = '';
        if (carIdInput) carIdInput.value = '';
      }
    };

    const selected = targetRadios.find((radio) => radio.checked);
    if (selected) {
      setTarget(selected.value);
    } else {
      carTarget.style.display = 'none';
      locationTarget.style.display = 'none';
    }

    targetRadios.forEach((radio) => {
      radio.addEventListener('change', (event) => {
        setTarget(event.target.value);
      });
    });

    if (carLookup) {
      carLookup.addEventListener('input', updateCarId);
      carLookup.addEventListener('change', updateCarId);
    }
    updateCarId();
  </script>
{% endblock %}
