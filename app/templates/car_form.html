{% extends "base.html" %}
{% block title %}
{% if car %}
  {% set title_mark = car.railroad.reporting_mark if car.railroad else (car.reporting_mark_override or '') %}
  {% set title_label = (title_mark ~ ' ' ~ (car.car_number or '')).strip() %}
  {{ title_label if title_label else ("Car ID " ~ car.id) }}
{% else %}
  New Car Entry
{% endif %}
{% endblock %}
{% block content %}
  <div class="box">
    <h1 class="title is-3">{{ 'Edit Car' if car else 'Add New Car' }}</h1>
    <form method="post" action="{{ form_action }}" data-mode="{{ 'edit' if car else 'new' }}" data-table="cars" data-id="{{ car.id if car else '' }}" data-id-field="id">
      <div class="box" style="margin-bottom: 16px;">
        <h2 class="title is-4">Location</h2>
        <div class="grid">
          <div class="field">
            <label class="label" for="location">Location</label>
            <div class="control">
              <input class="input" list="locations" id="location" name="location" value="{{ car.location.name if car and car.location else '' }}" />
              <datalist id="locations">
                {% for loc in locations %}
                  <option value="{{ loc.name }}"></option>
                {% endfor %}
              </datalist>
            </div>
          </div>
        </div>
      </div>

      <div class="box" style="margin-bottom: 16px;">
        <h2 class="title is-4">Railroad</h2>
        <div class="grid">
          <div class="field">
            <label class="label" for="reporting_mark">Reporting Mark</label>
            <div class="control">
              <input class="input" id="reporting_mark" name="reporting_mark" value="{{ car.railroad.reporting_mark if car and car.railroad else (car.reporting_mark_override if car else prefill.get('reporting_mark', '')) }}" {% if car and car.railroad %}disabled{% endif %} />
            </div>
          </div>
          <div class="field">
            <label class="label" for="railroad_name">Railroad Name</label>
            <div class="control">
              <input class="input" id="railroad_name" name="railroad_name" value="{{ car.railroad.name if car and car.railroad else (prefill.get('railroad_name', '') if not car else '') }}" {% if car and car.railroad %}disabled{% endif %} />
            </div>
          </div>
          {% if car and car.railroad %}
          <div class="field">
            <label class="label">Railroad Actions</label>
            <div class="control">
              <input type="hidden" id="clear_railroad" name="clear_railroad" value="0" data-confirm-include="true" data-confirm-label="Remove Railroad" />
              <button type="button" id="remove-railroad" class="button is-small is-light">Remove Railroad</button>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <div class="box" style="margin-bottom: 16px;">
        <h2 class="title is-4">Car ID</h2>
        <div class="grid">
          <div class="field">
            <label class="label" for="car_number">Car #</label>
            <div class="control">
              <input class="input" id="car_number" name="car_number" value="{{ car.car_number if car else '' }}" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="dcc_id">DCC ID</label>
            <div class="control">
              <input class="input" id="dcc_id" name="dcc_id" value="{{ car.dcc_id if car else '' }}" />
            </div>
          </div>
        </div>
      </div>

      <div class="box" style="margin-bottom: 16px;">
        <h2 class="title is-4">Car Info</h2>
        <h3 class="title is-5">Basics</h3>
        <div class="grid">
          <div class="field">
            <label class="label" for="car_class">Car Class</label>
            <div class="control">
              <input class="input" list="car_classes" id="car_class" name="car_class" value="{{ car.car_class.code if car and car.car_class else prefill.get('car_class', '') }}" />
              <datalist id="car_classes">
                {% for class in classes %}
                  <option value="{{ class.code }}"></option>
                {% endfor %}
              </datalist>
            </div>
          </div>
          <div class="field">
            <label class="label" for="car_type">Car Type</label>
            <div class="control">
              <input class="input" id="car_type" name="car_type" value="{{ car.car_type_override if car and car.car_type_override else (car.car_class.car_type if car and car.car_class else prefill.get('car_type', '')) }}" required data-gray-default="true" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="power_type">Power Type</label>
            <div class="control">
              <div class="select is-fullwidth">
                {% set power_type_value = car.power_type_override if car and car.power_type_override else (car.car_class.power_type if car and car.car_class else prefill.get('power_type', '')) %}
                <select id="power_type" name="power_type">
                  <option value="" {% if not power_type_value %}selected{% endif %}>-</option>
                  {% for power_type in power_type_options %}
                    <option value="{{ power_type }}" {% if power_type_value == power_type %}selected{% endif %}>{{ power_type }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
        </div>
        <h3 class="title is-5">Car Measurements</h3>
        <div class="grid">
          <div class="field">
            <label class="label" for="actual_weight_value">Actual Weight</label>
            <div class="control">
              {% set actual_weight_value = actual_weight_value if actual_weight_value is defined else (car.actual_weight if car else prefill.get('actual_weight', '')) %}
              <div class="field has-addons">
                <div class="control is-expanded">
                  <input class="input" id="actual_weight_value" name="actual_weight_value" value="{{ actual_weight_value }}" />
                </div>
                <div class="control">
                  {% set actual_weight_unit = actual_weight_unit if actual_weight_unit is defined else '' %}
                  <div class="select">
                    <select id="actual_weight_unit" name="actual_weight_unit">
                      <option value="" {% if not actual_weight_unit %}selected{% endif %}>Unit</option>
                      <option value="g" {% if actual_weight_unit == 'g' %}selected{% endif %}>g</option>
                      <option value="kg" {% if actual_weight_unit == 'kg' %}selected{% endif %}>kg</option>
                      <option value="lb" {% if actual_weight_unit == 'lb' %}selected{% endif %}>lb</option>
                      <option value="oz" {% if actual_weight_unit == 'oz' %}selected{% endif %}>oz</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <p class="help">NMRA Weight Check runs automatically when weight and length are saved.</p>
          </div>
          <div class="field">
            <label class="label" for="actual_length_value">Actual Length</label>
            <div class="control">
              {% set actual_length_value = actual_length_value if actual_length_value is defined else (car.actual_length if car else prefill.get('actual_length', '')) %}
              <div class="field has-addons">
                <div class="control is-expanded">
                  <input class="input" id="actual_length_value" name="actual_length_value" value="{{ actual_length_value }}" />
                </div>
                <div class="control">
                  {% set actual_length_unit = actual_length_unit if actual_length_unit is defined else '' %}
                  <div class="select">
                    <select id="actual_length_unit" name="actual_length_unit">
                      <option value="" {% if not actual_length_unit %}selected{% endif %}>Unit</option>
                      <option value="in" {% if actual_length_unit == 'in' %}selected{% endif %}>in</option>
                      <option value="ft" {% if actual_length_unit == 'ft' %}selected{% endif %}>ft</option>
                      <option value="mm" {% if actual_length_unit == 'mm' %}selected{% endif %}>mm</option>
                      <option value="cm" {% if actual_length_unit == 'cm' %}selected{% endif %}>cm</option>
                      <option value="m" {% if actual_length_unit == 'm' %}selected{% endif %}>m</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <h4 class="title is-6">Load Dimensions</h4>
        <div class="grid">
          <div class="field">
            <label class="label" for="load_length_value">Load Length</label>
            <div class="control">
              <div class="field has-addons">
                <div class="control is-expanded">
                  <input class="input" id="load_length_value" name="load_length_value" value="{{ load_length_value }}" />
                </div>
                <div class="control">
                  <div class="select">
                    <select id="load_length_unit" name="load_length_unit">
                      <option value="in" {% if load_length_unit == 'in' %}selected{% endif %}>in</option>
                      <option value="ft" {% if load_length_unit == 'ft' %}selected{% endif %}>ft</option>
                      <option value="mm" {% if load_length_unit == 'mm' %}selected{% endif %}>mm</option>
                      <option value="cm" {% if load_length_unit == 'cm' %}selected{% endif %}>cm</option>
                      <option value="m" {% if load_length_unit == 'm' %}selected{% endif %}>m</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="field">
            <label class="label" for="load_width_value">Load Width</label>
            <div class="control">
              <div class="field has-addons">
                <div class="control is-expanded">
                  <input class="input" id="load_width_value" name="load_width_value" value="{{ load_width_value }}" />
                </div>
                <div class="control">
                  <div class="select">
                    <select id="load_width_unit" name="load_width_unit">
                      <option value="in" {% if load_width_unit == 'in' %}selected{% endif %}>in</option>
                      <option value="ft" {% if load_width_unit == 'ft' %}selected{% endif %}>ft</option>
                      <option value="mm" {% if load_width_unit == 'mm' %}selected{% endif %}>mm</option>
                      <option value="cm" {% if load_width_unit == 'cm' %}selected{% endif %}>cm</option>
                      <option value="m" {% if load_width_unit == 'm' %}selected{% endif %}>m</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="field">
            <label class="label" for="load_height_value">Load Height</label>
            <div class="control">
              <div class="field has-addons">
                <div class="control is-expanded">
                  <input class="input" id="load_height_value" name="load_height_value" value="{{ load_height_value }}" />
                </div>
                <div class="control">
                  <div class="select">
                    <select id="load_height_unit" name="load_height_unit">
                      <option value="in" {% if load_height_unit == 'in' %}selected{% endif %}>in</option>
                      <option value="ft" {% if load_height_unit == 'ft' %}selected{% endif %}>ft</option>
                      <option value="mm" {% if load_height_unit == 'mm' %}selected{% endif %}>mm</option>
                      <option value="cm" {% if load_height_unit == 'cm' %}selected{% endif %}>cm</option>
                      <option value="m" {% if load_height_unit == 'm' %}selected{% endif %}>m</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <h4 class="title is-6">Scale &amp; Gauge</h4>
        <div class="grid">
          {% set scale_value = scale_value if scale_value is defined else (car.scale if car else prefill.get('scale', '')) %}
          {% set scale_state = namespace(found=false) %}
          {% for option in scale_options %}
            {% if option.value == scale_value %}
              {% set scale_state.found = true %}
            {% endif %}
          {% endfor %}
          <div class="field">
            <label class="label" for="scale">Scale</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select id="scale" name="scale">
                  <option value="" {% if not scale_value %}selected{% endif %}>Unset</option>
                  {% if scale_value and not scale_state.found %}
                    <option value="{{ scale_value }}" selected>{{ scale_value }}</option>
                  {% endif %}
                  {% for option in scale_options %}
                    <option value="{{ option.value }}" {% if option.value == scale_value %}selected{% endif %}>{{ option.label }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          {% set gauge_value = gauge_value if gauge_value is defined else (car.gauge if car else prefill.get('gauge', '')) %}
          {% set gauge_state = namespace(found=false) %}
          {% for option in gauge_options %}
            {% if option.value == gauge_value %}
              {% set gauge_state.found = true %}
            {% endif %}
          {% endfor %}
          <div class="field">
            <label class="label" for="gauge">Gauge</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select id="gauge" name="gauge">
                  <option value="" {% if not gauge_value %}selected{% endif %}>Unset</option>
                  {% if gauge_value and not gauge_state.found %}
                    <option value="{{ gauge_value }}" selected>{{ gauge_value }}</option>
                  {% endif %}
                  {% for option in gauge_options %}
                    <option value="{{ option.value }}" {% if option.value == gauge_value %}selected{% endif %}>{{ option.label }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          {% if common_scale_gauge %}
            <div class="field">
              <label class="label">Quick Sets</label>
              <div class="buttons">
                {% for combo in common_scale_gauge %}
                  <button type="button" class="button is-small is-light scale-gauge-quick" data-scale="{{ combo.scale }}" data-gauge="{{ combo.gauge }}">
                    {{ combo.label }}
                  </button>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      <div class="box" style="margin-bottom: 16px;">
        <h2 class="title is-4">Car Prototype</h2>
        <article class="message is-info" style="margin-bottom: 16px;">
          <div class="message-body">
            <ul>
              <li>CAPY - Load Capacity</li>
              <li>LD LMT - Load Limit</li>
              <li>LT WT - Car Weight</li>
            </ul>
          </div>
        </article>
        <h3 class="title is-5">Prototype Specifications</h3>
        <div class="grid">
          {% set aar_plate_value = car.aar_plate_override if car and car.aar_plate_override else (prefill.get('aar_plate', '') if not car else '') %}
          <div class="field">
            <label class="label" for="capacity">Capacity</label>
            <div class="control">
              <input class="input" id="capacity" name="capacity" value="{{ car.capacity_override if car and car.capacity_override else (prefill.get('capacity', '') if not car else '') }}" data-gray-default="true" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="load_limit">Load Limit</label>
            <div class="control">
              <input class="input" id="load_limit" name="load_limit" value="{{ car.load_limit_override if car and car.load_limit_override else (prefill.get('load_limit', '') if not car else '') }}" data-gray-default="true" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="weight">Weight</label>
            <div class="control">
              <input class="input" id="weight" name="weight" value="{{ car.weight_override if car and car.weight_override else (prefill.get('weight', '') if not car else '') }}" data-gray-default="true" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="aar_plate">AAR Plate</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select id="aar_plate" name="aar_plate" data-gray-default="true">
                  <option value="" {% if not aar_plate_value %}selected{% endif %}>Unset</option>
                  <option value="B" {% if aar_plate_value == 'B' %}selected{% endif %}>B</option>
                  <option value="C" {% if aar_plate_value == 'C' %}selected{% endif %}>C</option>
                  <option value="E" {% if aar_plate_value == 'E' %}selected{% endif %}>E</option>
                  <option value="F" {% if aar_plate_value == 'F' %}selected{% endif %}>F</option>
                  <option value="H" {% if aar_plate_value == 'H' %}selected{% endif %}>H</option>
                  <option value="J" {% if aar_plate_value == 'J' %}selected{% endif %}>J</option>
                  <option value="K" {% if aar_plate_value == 'K' %}selected{% endif %}>K</option>
                  <option value="L" {% if aar_plate_value == 'L' %}selected{% endif %}>L</option>
                  <option value="M" {% if aar_plate_value == 'M' %}selected{% endif %}>M</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <h3 class="title is-5">Prototype Dimensions</h3>
        <div class="grid">
          <div class="field">
            <label class="label" for="internal_length">Prototype Length</label>
            <div class="control">
              <input class="input" id="internal_length" name="internal_length" value="{{ car.internal_length_override if car and car.internal_length_override else (prefill.get('internal_length', '') if not car else '') }}" data-gray-default="true" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="internal_width">Prototype Width</label>
            <div class="control">
              <input class="input" id="internal_width" name="internal_width" value="{{ car.internal_width_override if car and car.internal_width_override else (prefill.get('internal_width', '') if not car else '') }}" data-gray-default="true" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="internal_height">Prototype Height</label>
            <div class="control">
              <input class="input" id="internal_height" name="internal_height" value="{{ car.internal_height_override if car and car.internal_height_override else (prefill.get('internal_height', '') if not car else '') }}" data-gray-default="true" />
            </div>
          </div>
        </div>
        <h3 class="title is-5">Dates</h3>
        <div class="grid">
          <div class="field">
            <label class="label" for="built">Built</label>
            <div class="control">
              <input class="input" id="built" name="built" value="{{ car.built if car else prefill.get('built', '') }}" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="alt_date">Alt Date</label>
            <div class="control">
              <input class="input" id="alt_date" name="alt_date" value="{{ car.alt_date if car else '' }}" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="reweight_date">Reweight Date</label>
            <div class="control">
              <input class="input" id="reweight_date" name="reweight_date" value="{{ car.reweight_date if car else '' }}" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="repack_bearings_date">Repack Bearings Date</label>
            <div class="control">
              <input class="input" id="repack_bearings_date" name="repack_bearings_date" value="{{ car.repack_bearings_date if car else '' }}" />
            </div>
          </div>
        </div>
        <h3 class="title is-5">Lettering &amp; Options</h3>
        <div class="grid">
          <div class="field">
            <label class="label" for="class_wheel_arrangement">Locomotive Class Wheel Arrangement</label>
            <div class="control">
              <input class="input" id="class_wheel_arrangement" name="class_wheel_arrangement" value="{{ car.wheel_arrangement_override if car and car.wheel_arrangement_override else (car.car_class.wheel_arrangement if car and car.car_class else '') }}" data-gray-default="true" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="class_tender_axles">Class Tender Axles</label>
            <div class="control">
              <input class="input" id="class_tender_axles" name="class_tender_axles" value="{{ car.tender_axles_override if car and car.tender_axles_override else (car.car_class.tender_axles if car and car.car_class else '') }}" data-gray-default="true" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="other_lettering">Other Lettering</label>
            <div class="control">
              <input class="input" id="other_lettering" name="other_lettering" value="{{ car.other_lettering if car else '' }}" />
            </div>
          </div>
          <div class="field">
            <label class="label">Traction Drivers</label>
            <div class="control">
              <label class="checkbox">
                <input id="traction_drivers" type="checkbox" name="traction_drivers" {% if car and car.traction_drivers %}checked{% endif %} />
                Enabled
              </label>
            </div>
          </div>
          <div class="field">
            <label class="label" for="load">Load</label>
            <div class="control">
              <input class="input" id="load" name="load" value="{{ car.load if car else '' }}" />
            </div>
          </div>
          <div class="field">
            <label class="label">Locomotive</label>
            <div class="control">
              <label class="checkbox">
                <input id="is_locomotive" type="checkbox" name="is_locomotive" {% if car and (car.is_locomotive_override if car.is_locomotive_override is not none else (car.car_class.is_locomotive if car.car_class else false)) %}checked{% endif %} />
                Enabled
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="box" style="margin-bottom: 16px;">
        <h2 class="title is-4">Asset</h2>
        <div class="grid">
          <div class="field">
            <label class="label" for="msrp">MSRP</label>
            <div class="control">
              <input class="input" id="msrp" name="msrp" value="{{ car.msrp if car else prefill.get('msrp', '') }}" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="price">Purchase Price</label>
            <div class="control">
              <input class="input" id="price" name="price" value="{{ car.price if car else prefill.get('price', '') }}" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="brand">Brand</label>
            <div class="control">
              <input class="input" id="brand" name="brand" value="{{ car.brand if car else prefill.get('brand', '') }}" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="upc">UPC</label>
            <div class="control">
              <input class="input" id="upc" name="upc" value="{{ car.upc if car else '' }}" />
            </div>
          </div>
        </div>
      </div>

      <div class="box" style="margin-bottom: 16px;">
        <h2 class="title is-4">Other Information</h2>
        <div class="grid">
          <div class="field">
            <label class="label" for="repairs_required">Repairs Required</label>
            <div class="control">
              <textarea class="textarea" id="repairs_required" name="repairs_required" rows="4">{{ car.repairs_required if car else '' }}</textarea>
            </div>
          </div>
          <div class="field">
            <label class="label" for="notes">Notes</label>
            <div class="control">
              <textarea class="textarea" id="notes" name="notes" rows="4">{{ car.notes if car else '' }}</textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="actions buttons">
        <button type="submit" class="button is-small is-primary">Save</button>
        <a class="button is-small is-light" href="{{ url_for('main.inventory') }}">Cancel</a>
      </div>
    </form>
  </div>
  <script>
    const scaleSelect = document.getElementById('scale');
    const gaugeSelect = document.getElementById('gauge');
    const setSelectValue = (select, value) => {
      if (!select) return;
      const option = Array.from(select.options).find((item) => item.value === value);
      if (!option && value) {
        const newOption = document.createElement('option');
        newOption.value = value;
        newOption.textContent = value;
        select.appendChild(newOption);
      }
      select.value = value || '';
    };

    document.querySelectorAll('.scale-gauge-quick').forEach((button) => {
      button.addEventListener('click', () => {
        setSelectValue(scaleSelect, button.dataset.scale || '');
        setSelectValue(gaugeSelect, button.dataset.gauge || '');
      });
    });

    const removeRailroadButton = document.getElementById('remove-railroad');
    if (removeRailroadButton) {
      removeRailroadButton.addEventListener('click', () => {
        const flag = document.getElementById('clear_railroad');
        if (flag) flag.value = '1';
        const form = removeRailroadButton.closest('form');
        if (!form) return;
        if (form.requestSubmit) {
          form.requestSubmit();
        } else {
          form.submit();
        }
      });
    }
    const classFields = {
      wheel: document.getElementById('class_wheel_arrangement'),
      tender: document.getElementById('class_tender_axles'),
      capacity: document.getElementById('capacity'),
      weight: document.getElementById('weight'),
      loadLimit: document.getElementById('load_limit'),
      aarPlate: document.getElementById('aar_plate'),
      internalLength: document.getElementById('internal_length'),
      internalWidth: document.getElementById('internal_width'),
      internalHeight: document.getElementById('internal_height'),
      carType: document.getElementById('car_type'),
      powerType: document.getElementById('power_type'),
      locomotive: document.getElementById('is_locomotive'),
    };

    const hasValue = (input) => input && input.value && input.value.trim() !== '';

    const setGrayDefault = (input, value) => {
      if (!input || !input.dataset.grayDefault) return;
      if (hasValue(input)) return;
      if (!value) return;
      input.value = value;
      input.dataset.defaultValue = value;
      input.dataset.isDefault = 'true';
      input.style.color = '#666666';
    };

    const clearGrayDefault = (input) => {
      if (!input || input.dataset.isDefault !== 'true') return;
      if (input.tagName === 'SELECT') return;
      input.value = '';
      input.dataset.isDefault = 'false';
      input.style.color = '';
    };

    const setSelectDefault = (select, value) => {
      if (!select || !value) return;
      if (select.value) return;
      setSelectValue(select, value);
    };

    const wheelField = document.getElementById('class_wheel_arrangement')?.closest('div');
    const tenderField = document.getElementById('class_tender_axles')?.closest('div');
    const locomotiveInput = document.getElementById('is_locomotive');
    const updateTenderVisibility = () => {
      if (!locomotiveInput) return;
      const show = locomotiveInput.checked;
      if (wheelField) wheelField.style.display = show ? '' : 'none';
      if (tenderField) tenderField.style.display = show ? '' : 'none';
    };

    const applyClassDetails = (carClass) => {
      if (!carClass) return;
      if (classFields.wheel) setGrayDefault(classFields.wheel, carClass.wheel_arrangement);
      if (classFields.tender) setGrayDefault(classFields.tender, carClass.tender_axles);
      setGrayDefault(classFields.capacity, carClass.capacity);
      setGrayDefault(classFields.weight, carClass.weight);
      setGrayDefault(classFields.loadLimit, carClass.load_limit);
      setGrayDefault(classFields.aarPlate, carClass.aar_plate);
      setGrayDefault(classFields.internalLength, carClass.internal_length);
      setGrayDefault(classFields.internalWidth, carClass.internal_width);
      setGrayDefault(classFields.internalHeight, carClass.internal_height);
      if (classFields.carType) {
        setGrayDefault(classFields.carType, carClass.car_type);
      }
      if (classFields.powerType) {
        setSelectDefault(classFields.powerType, carClass.power_type);
      }
      if (classFields.locomotive && carClass.is_locomotive !== null && carClass.is_locomotive !== undefined) {
        classFields.locomotive.checked = !!carClass.is_locomotive;
      }
      updateTenderVisibility();
    };

    const classInput = document.getElementById('car_class');
    const loadClassDetails = async (code) => {
      if (!code) return;
      try {
        const response = await fetch('{{ url_for("main.api_car_classes") }}');
        if (!response.ok) return;
        const classes = await response.json();
        const match = classes.find((item) => item.code === code);
        applyClassDetails(match);
      } catch (error) {
        console.warn('Failed to load car class details', error);
      }
    };

    if (classInput) {
      classInput.addEventListener('change', () => loadClassDetails(classInput.value.trim()));
      if (classInput.value.trim()) {
        loadClassDetails(classInput.value.trim());
      }
    }

    if (locomotiveInput) {
      locomotiveInput.addEventListener('change', updateTenderVisibility);
      updateTenderVisibility();
    }

    const focusNextField = (current) => {
      const form = current?.closest('form');
      if (!form) return;
      const focusable = Array.from(form.querySelectorAll('input, select, textarea, button, [tabindex]'))
        .filter((el) => !el.disabled && el.type !== 'hidden' && el.tabIndex !== -1);
      const index = focusable.indexOf(current);
      if (index > -1 && index + 1 < focusable.length) {
        focusable[index + 1].focus();
      }
    };

    const locationInput = document.getElementById('location');
    if (locationInput) {
      locationInput.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter') return;
        event.preventDefault();
        focusNextField(locationInput);
      });
    }

    const reportingInput = document.getElementById('reporting_mark');
    const railroadInput = document.getElementById('railroad_name');
    if (reportingInput && railroadInput) {
      reportingInput.addEventListener('change', async () => {
        const mark = reportingInput.value.trim();
        if (!mark || railroadInput.value.trim()) return;
        try {
          const response = await fetch('{{ url_for("main.api_railroads") }}');
          if (!response.ok) return;
          const railroads = await response.json();
          const match = railroads.find((item) => item.reporting_mark === mark);
          if (match && match.name) {
            railroadInput.value = match.name;
          }
        } catch (error) {
          console.warn('Failed to load railroad details', error);
        }
      });
    }

    [classFields.capacity, classFields.weight, classFields.loadLimit, classFields.aarPlate, classFields.internalLength, classFields.internalWidth, classFields.internalHeight, classFields.carType, classFields.wheel, classFields.tender].forEach((input) => {
      if (!input) return;
      input.addEventListener('focus', () => clearGrayDefault(input));
      input.addEventListener('input', () => {
        if (input.dataset.isDefault === 'true') {
          clearGrayDefault(input);
        }
        input.style.color = '';
      });
      input.addEventListener('change', () => {
        if (input.dataset.isDefault === 'true') {
          input.dataset.isDefault = 'false';
        }
        input.style.color = '';
      });
    });

    const form = document.querySelector('form[data-mode]');
    if (form) {
      form.addEventListener('submit', () => {
        [classFields.capacity, classFields.weight, classFields.loadLimit, classFields.aarPlate, classFields.internalLength, classFields.internalWidth, classFields.internalHeight].forEach((input) => {
          if (input && input.dataset.isDefault === 'true') {
            input.value = '';
          }
        });
      });
    }
  </script>
{% endblock %}
