{% extends "base.html" %}
{% block content %}
  <div class="box">
    {% set copy_reporting_mark = car.railroad.reporting_mark if car.railroad else (car.reporting_mark_override or '') %}
    {% set copy_railroad_name = car.railroad.name if car.railroad else '' %}
    {% set copy_built = car.built or '' %}
    {% set copy_brand = car.brand or '' %}
    {% set copy_price = car.price or '' %}
    {% set copy_msrp = car.msrp or '' %}
    {% set copy_actual_weight = car.actual_weight or '' %}
    {% set copy_actual_length = car.actual_length or '' %}
    {% set copy_scale = car.scale or '' %}
    {% set copy_gauge = car.gauge or '' %}
    {% if car.car_class %}
      {% set copy_car_class = car.car_class.code or '' %}
      {% set copy_car_type = car.car_class.car_type or '' %}
      {% set copy_power_type = car.car_class.power_type or '' %}
      {% set copy_capacity = car.car_class.capacity or '' %}
      {% set copy_weight = car.car_class.weight or '' %}
      {% set copy_load_limit = car.car_class.load_limit or '' %}
      {% set copy_aar_plate = car.car_class.aar_plate or '' %}
      {% set copy_override_car_type = car.car_type_override or '' %}
      {% set copy_override_power_type = car.power_type_override or '' %}
      {% set copy_override_capacity = car.capacity_override or '' %}
      {% set copy_override_weight = car.weight_override or '' %}
      {% set copy_override_load_limit = car.load_limit_override or '' %}
      {% set copy_override_aar_plate = car.aar_plate_override or '' %}
    {% else %}
      {% set copy_car_class = '' %}
      {% set copy_car_type = car.car_type_override or '' %}
      {% set copy_power_type = car.power_type_override or '' %}
      {% set copy_capacity = car.capacity_override or '' %}
      {% set copy_weight = car.weight_override or '' %}
      {% set copy_load_limit = car.load_limit_override or '' %}
      {% set copy_aar_plate = car.aar_plate_override or '' %}
      {% set copy_override_car_type = copy_car_type %}
      {% set copy_override_power_type = copy_power_type %}
      {% set copy_override_capacity = copy_capacity %}
      {% set copy_override_weight = copy_weight %}
      {% set copy_override_load_limit = copy_load_limit %}
      {% set copy_override_aar_plate = copy_aar_plate %}
    {% endif %}
    <h1 class="title is-3">
      {{ (car.railroad.reporting_mark if car.railroad else car.reporting_mark_override) or "" }} {{ car.car_number or "" }}
      {% if car.railroad and car.railroad.representative_logo and car.railroad.representative_logo.image_path %}
        <img src="{{ url_for('static', filename=car.railroad.representative_logo.image_path) }}" alt="{{ car.railroad.representative_logo.description or car.railroad.name }}" style="max-height: 32px; max-width: 96px; margin-left: 8px; vertical-align: middle;" />
      {% endif %}
    </h1>
    <div class="actions buttons">
      <a class="button is-small is-info" href="{{ url_for('main.car_edit', car_id=car.id) }}">Edit</a>
      <a class="button is-small is-warning" href="{{ url_for('main.car_inspect', car_id=car.id) }}">Inspect</a>
      <button type="button" class="button is-small is-success" id="copy-trigger">Copy...</button>
      <button type="button" id="compare-trigger" {% if not compare_cars %}disabled{% endif %} class="button is-small is-link">Compare</button>
      <form method="post" action="{{ url_for('main.car_delete', car_id=car.id) }}" data-action="delete" data-table="cars" data-id="{{ car.id }}" data-id-field="id" data-entity-label="car {{ car.id }}">
        <button type="submit" class="button is-small is-danger">Delete</button>
      </form>
      <a class="button is-small is-light" href="{{ url_for('main.inventory') }}">Back to Inventory</a>
    </div>
    <div class="grid">
      <div>
        <h3 class="title is-5">Identity</h3>
        <p><strong>Type:</strong> {{ car.car_type_override or (car.car_class.car_type if car.car_class else "-") }}</p>
        <p><strong>Power Type:</strong> {{ car.power_type_override or (car.car_class.power_type if car.car_class else "-") }}</p>
        <p><strong>Class:</strong>
          {% if car.car_class %}
            <a href="{{ url_for('main.car_class_detail', class_id=car.car_class.id) }}">{{ car.car_class.code }}</a>
          {% else %}
            -
          {% endif %}
        </p>
        <p><strong>Class Era:</strong> {{ car.car_class.era if car.car_class and car.car_class.era else "-" }}</p>
        <p><strong>Railroad:</strong>
          {% if car.railroad %}
            <a href="{{ url_for('main.railroad_detail', railroad_id=car.railroad.id) }}">{{ car.railroad.name }}</a>
          {% else %}
            -
          {% endif %}
        </p>
        <p><strong>Reporting Mark:</strong>
          {% if car.railroad %}
            <a href="{{ url_for('main.railroad_detail', railroad_id=car.railroad.id) }}">{{ car.railroad.reporting_mark or "-" }}</a>
          {% else %}
            {{ car.reporting_mark_override or "-" }}
          {% endif %}
        </p>
      </div>
      <div>
        <h3 class="title is-5">Location</h3>
        <p><strong>Location:</strong>
          {% if car.location %}
            <a href="{{ url_for('main.location_detail', location_id=car.location.id) }}">{{ car.location.name }}</a>
          {% else %}
            -
          {% endif %}
        </p>
      </div>
      <div>
        <h3 class="title is-5">Specs</h3>
        <p><strong>Wheel Arrangement:</strong> {{ car.wheel_arrangement_override or (car.car_class.wheel_arrangement if car.car_class else "-") }}</p>
        {% if car.car_class and car.car_class.tender_axles %}
          <p><strong>Tender Axles:</strong> {{ car.tender_axles_override or car.car_class.tender_axles }}</p>
        {% elif car.tender_axles_override %}
          <p><strong>Tender Axles:</strong> {{ car.tender_axles_override }}</p>
        {% endif %}
        <p><strong>DCC ID:</strong> {{ car.dcc_id or "-" }}</p>
        <p><strong>Actual Weight:</strong> {{ car.actual_weight or "-" }}</p>
        <p><strong>Actual Length:</strong> {{ car.actual_length or "-" }}</p>
        <p><strong>Scale:</strong> {{ scale_label or "-" }}</p>
        <p><strong>Gauge:</strong> {{ gauge_label or "-" }}</p>
        <p><strong>Linear Density:</strong> {{ linear_density or "-" }}</p>
      </div>
      <div>
        <h3 class="title is-5">Pricing</h3>
        <p><strong>MSRP:</strong> {{ car.msrp or "-" }}</p>
        <p><strong>Price:</strong> {{ car.price or "-" }}</p>
      </div>
      <div>
        <h3 class="title is-5">Lettering</h3>
        <p><strong>Capacity:</strong>
          {% if car.capacity_override %}
            {{ car.capacity_override }}{% if car.car_class %} (override){% endif %}
          {% else %}
            {{ car.car_class.capacity if car.car_class else "-" }}
          {% endif %}
        </p>
        <p><strong>Weight:</strong>
          {% if car.weight_override %}
            {{ car.weight_override }}{% if car.car_class %} (override){% endif %}
          {% else %}
            {{ car.car_class.weight if car.car_class else "-" }}
          {% endif %}
        </p>
        <p><strong>Load Limit:</strong>
          {% if car.load_limit_override %}
            {{ car.load_limit_override }}{% if car.car_class %} (override){% endif %}
          {% else %}
            {{ car.car_class.load_limit if car.car_class else "-" }}
          {% endif %}
        </p>
        <p><strong>AAR Plate:</strong>
          {% if car.aar_plate_override %}
            {{ car.aar_plate_override }}{% if car.car_class %} (override){% endif %}
          {% else %}
            {{ car.car_class.aar_plate if car.car_class else "-" }}
          {% endif %}
        </p>
        <p><strong>Load Length:</strong> {{ car.load_length or "-" }}</p>
        <p><strong>Load Width:</strong> {{ car.load_width or "-" }}</p>
        <p><strong>Load Height:</strong> {{ car.load_height or "-" }}</p>
        <p><strong>Prototype Length:</strong> {{ car.internal_length_override or (car.car_class.internal_length if car.car_class else "-") }}</p>
        <p><strong>Prototype Width:</strong> {{ car.internal_width_override or (car.car_class.internal_width if car.car_class else "-") }}</p>
        <p><strong>Prototype Height:</strong> {{ car.internal_height_override or (car.car_class.internal_height if car.car_class else "-") }}</p>
        <p><strong>Built:</strong> {{ car.built or "-" }}</p>
        <p><strong>Alt Date:</strong> {{ car.alt_date or "-" }}</p>
        <p><strong>Reweigh Date:</strong> {{ car.reweight_date or "-" }}</p>
        <p><strong>Repack Bearings Date:</strong> {{ car.repack_bearings_date or "-" }}</p>
      </div>
      <div>
        <h3 class="title is-5">Maintenance</h3>
        <p><strong>Last Inspection Date:</strong> {{ car.last_inspection_date or "-" }}</p>
        <p><strong>Repairs Required:</strong> {{ car.repairs_required or "None" }}</p>
        <p><strong>Notes:</strong> {{ car.notes or "-" }}</p>
      </div>
    </div>
    <h3 class="title is-5">Inspections</h3>
    <table class="table is-fullwidth is-striped">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Result</th>
          <th>Details</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for inspection in car.inspections %}
        <tr>
          <td>{{ inspection.inspection_date or "-" }}</td>
          <td>{{ inspection.inspection_type.name if inspection.inspection_type else "-" }}</td>
          <td>
            {% if inspection.passed is none %}
              -
            {% elif inspection.passed %}
              Passed
            {% else %}
              Failed
            {% endif %}
          </td>
          <td>{{ inspection.details or "-" }}</td>
          <td>
            <form method="post" action="{{ url_for('main.inspection_delete', inspection_id=inspection.id) }}" data-action="delete" data-table="car_inspections" data-id="{{ inspection.id }}" data-id-field="id" data-entity-label="inspection {{ inspection.id }}" style="display: inline;">
              <input type="hidden" name="next" value="{{ url_for('main.car_detail', car_id=car.id) }}" />
              <button type="submit" class="button is-small is-danger">Delete</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5">No inspections recorded.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <h3 class="title is-5">Loads</h3>
    <div class="actions buttons">
      <a class="button is-small is-primary" href="{{ url_for('main.load_placement_new_generic', car_id=car.id) }}">Add Load</a>
    </div>
    <table class="table is-fullwidth is-striped">
      <thead>
        <tr>
          <th>Load</th>
          <th>Quantity</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for placement in car.load_placements %}
        <tr>
          <td><a href="{{ url_for('main.load_detail', load_id=placement.load.id) }}">{{ placement.load.name }}</a></td>
          <td>{{ placement.quantity }}</td>
          <td>
            <a class="button is-small is-light" href="{{ url_for('main.load_placement_edit', placement_id=placement.id) }}">Move/Edit</a>
            <form method="post" action="{{ url_for('main.load_placement_delete', placement_id=placement.id) }}" data-action="delete" data-table="load_placements" data-id="{{ placement.id }}" data-id-field="id" data-entity-label="placement {{ placement.id }}" style="display: inline;">
              <button type="submit" class="button is-small is-danger">Delete</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="3">No loads assigned to this car.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div id="compare-modal" class="compare-overlay" style="display: none;" aria-hidden="true">
    <div class="compare-dialog" role="dialog" aria-modal="true" aria-labelledby="compare-title">
      <h2 class="title is-4" id="compare-title">Compare railcars</h2>
      <p class="keyboard-hint">Select another car to compare with this one.</p>
      <label class="label" for="compare-car-select">Railcar ID</label>
      <div class="control">
        <div class="select is-fullwidth">
          <select id="compare-car-select">
            <option value="">Select a railcar</option>
            {% for option in compare_cars %}
              <option value="{{ option.id }}">{{ option.id }} - {{ option.reporting_mark or "-" }} {{ option.car_number or "" }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="compare-actions">
        <button type="button" id="compare-cancel" class="button is-small is-light">Cancel</button>
        <button type="button" id="compare-apply" disabled class="button is-small is-primary">Compare</button>
      </div>
    </div>
  </div>
  <div id="compare-result-modal" class="compare-overlay" style="display: none;" aria-hidden="true">
    <div class="compare-dialog" role="dialog" aria-modal="true" aria-labelledby="compare-result-title">
      <h2 class="title is-4" id="compare-result-title">Comparison</h2>
      <p class="keyboard-hint" id="compare-summary"></p>
      <table class="table is-fullwidth is-striped">
        <thead>
          <tr>
            <th>Field</th>
            <th>This Car</th>
            <th>Other Car</th>
          </tr>
        </thead>
        <tbody id="compare-body"></tbody>
      </table>
      <div class="compare-actions">
        <button type="button" id="compare-result-close" class="button is-small is-light">Close</button>
      </div>
    </div>
  </div>
  <div id="copy-modal" class="compare-overlay" style="display: none;" aria-hidden="true">
    <div class="compare-dialog" role="dialog" aria-modal="true" aria-labelledby="copy-title">
      <h2 class="title is-4" id="copy-title">Copy to new car</h2>
      <p class="keyboard-hint">Choose how much of this car to copy into a new entry.</p>
      <article class="message is-success">
        <div class="message-body">
          <strong>Copy to New Car</strong> copies the railroad, class, and core lettering details.
          Use this when you want a quick new entry that matches the class defaults.
          <div class="actions buttons" style="margin-top: 12px;">
            <a class="button is-small is-success" href="{{ url_for('main.car_new', reporting_mark=copy_reporting_mark, railroad_name=copy_railroad_name, car_class=copy_car_class, car_type=copy_car_type, power_type=copy_power_type, capacity=copy_capacity, weight=copy_weight, load_limit=copy_load_limit, aar_plate=copy_aar_plate, actual_weight=copy_actual_weight, actual_length=copy_actual_length, scale=copy_scale, gauge=copy_gauge) }}">Copy to New Car</a>
          </div>
        </div>
      </article>
      <article class="message is-success">
        <div class="message-body">
          <strong>Copy to New Car (Overrides)</strong> keeps any overrides you set for this car
          (type, capacity, weight, load limit, AAR plate) instead of class defaults.
          <div class="actions buttons" style="margin-top: 12px;">
            <a class="button is-small is-success" href="{{ url_for('main.car_new', reporting_mark=copy_reporting_mark, railroad_name=copy_railroad_name, car_class=copy_car_class, car_type=copy_override_car_type, power_type=copy_override_power_type, capacity=copy_override_capacity, weight=copy_override_weight, load_limit=copy_override_load_limit, aar_plate=copy_override_aar_plate, actual_weight=copy_actual_weight, actual_length=copy_actual_length, scale=copy_scale, gauge=copy_gauge) }}">Copy to New Car (Overrides)</a>
          </div>
        </div>
      </article>
      <article class="message is-success">
        <div class="message-body">
          <strong>Copy to New Car (Clone)</strong> brings over everything, including built date,
          brand, price, and MSRP for a near-duplicate entry.
          <div class="actions buttons" style="margin-top: 12px;">
            <a class="button is-small is-success" href="{{ url_for('main.car_new', reporting_mark=copy_reporting_mark, railroad_name=copy_railroad_name, car_class=copy_car_class, car_type=copy_override_car_type, power_type=copy_override_power_type, capacity=copy_override_capacity, weight=copy_override_weight, load_limit=copy_override_load_limit, aar_plate=copy_override_aar_plate, actual_weight=copy_actual_weight, actual_length=copy_actual_length, scale=copy_scale, gauge=copy_gauge, built=copy_built, brand=copy_brand, price=copy_price, msrp=copy_msrp) }}">Copy to New Car (Clone)</a>
          </div>
        </div>
      </article>
      <div class="compare-actions">
        <button type="button" class="button is-small is-light" id="copy-cancel">Close</button>
      </div>
    </div>
  </div>
  <script>
    const compareTrigger = document.getElementById('compare-trigger');
    const compareModal = document.getElementById('compare-modal');
    const compareResultModal = document.getElementById('compare-result-modal');
    const compareSelect = document.getElementById('compare-car-select');
    const compareApply = document.getElementById('compare-apply');
    const compareCancel = document.getElementById('compare-cancel');
    const compareBody = document.getElementById('compare-body');
    const compareSummary = document.getElementById('compare-summary');
    const compareResultClose = document.getElementById('compare-result-close');
    const currentCar = {{ car_payload | tojson }};
    let compareFocusReturn = null;
    const copyTrigger = document.getElementById('copy-trigger');
    const copyModal = document.getElementById('copy-modal');
    const copyCancel = document.getElementById('copy-cancel');
    let copyFocusReturn = null;

    const compareFields = [
      { key: 'id', label: 'ID' },
      { key: 'reporting_mark', label: 'Reporting Mark' },
      { key: 'car_number', label: 'Car #' },
      { key: 'car_type', label: 'Type' },
      { key: 'car_class', label: 'Class' },
      { key: 'railroad', label: 'Railroad' },
      { key: 'location', label: 'Location' },
      { key: 'wheel_arrangement', label: 'Wheel Arrangement' },
      { key: 'tender_axles', label: 'Tender Axles' },
      { key: 'dcc_id', label: 'DCC ID' },
      { key: 'capacity', label: 'Capacity' },
      { key: 'weight', label: 'Weight' },
      { key: 'load_limit', label: 'Load Limit' },
      { key: 'actual_weight', label: 'Actual Weight' },
      { key: 'actual_length', label: 'Actual Length' },
      { key: 'load_length', label: 'Load Length' },
      { key: 'load_width', label: 'Load Width' },
      { key: 'load_height', label: 'Load Height' },
      { key: 'scale', label: 'Scale' },
      { key: 'gauge', label: 'Gauge' },
      { key: 'aar_plate', label: 'AAR Plate' },
      { key: 'internal_length', label: 'Prototype Length' },
      { key: 'internal_width', label: 'Prototype Width' },
      { key: 'internal_height', label: 'Prototype Height' },
      { key: 'built', label: 'Built' },
      { key: 'alt_date', label: 'Alt Date' },
      { key: 'reweight_date', label: 'Reweigh Date' },
      { key: 'repack_bearings_date', label: 'Repack Bearings Date' },
      { key: 'last_inspection_date', label: 'Last Inspection Date' },
      { key: 'brand', label: 'Brand' },
      { key: 'upc', label: 'UPC' },
      { key: 'traction_drivers', label: 'Traction Drivers' },
      { key: 'other_lettering', label: 'Other Lettering' },
      { key: 'msrp', label: 'MSRP' },
      { key: 'price', label: 'Price' },
      { key: 'load', label: 'Load' },
      { key: 'repairs_required', label: 'Repairs Required' },
      { key: 'notes', label: 'Notes' },
      { key: 'is_locomotive', label: 'Locomotive' },
    ];

    const formatCompareValue = (value) => {
      if (value === null || value === undefined || value === '') {
        return '-';
      }
      if (typeof value === 'boolean') {
        return value ? 'Yes' : 'No';
      }
      return String(value);
    };

    const openCompareModal = () => {
      compareFocusReturn = document.activeElement;
      compareSelect.value = '';
      compareApply.disabled = true;
      compareModal.style.display = 'flex';
      compareModal.setAttribute('aria-hidden', 'false');
      compareSelect.focus();
    };

    const closeCompareModal = () => {
      compareModal.style.display = 'none';
      compareModal.setAttribute('aria-hidden', 'true');
      if (compareFocusReturn) {
        compareFocusReturn.focus();
      }
    };

    const openCompareResultModal = () => {
      compareResultModal.style.display = 'flex';
      compareResultModal.setAttribute('aria-hidden', 'false');
      compareResultClose.focus();
    };

    const closeCompareResultModal = () => {
      compareResultModal.style.display = 'none';
      compareResultModal.setAttribute('aria-hidden', 'true');
    };

    compareTrigger?.addEventListener('click', openCompareModal);
    compareCancel?.addEventListener('click', closeCompareModal);
    compareResultClose?.addEventListener('click', closeCompareResultModal);

    const openCopyModal = () => {
      copyFocusReturn = document.activeElement;
      copyModal.style.display = 'flex';
      copyModal.setAttribute('aria-hidden', 'false');
      copyCancel.focus();
    };

    const closeCopyModal = () => {
      copyModal.style.display = 'none';
      copyModal.setAttribute('aria-hidden', 'true');
      if (copyFocusReturn) {
        copyFocusReturn.focus();
      }
    };

    copyTrigger?.addEventListener('click', openCopyModal);
    copyCancel?.addEventListener('click', closeCopyModal);

    compareSelect?.addEventListener('change', (event) => {
      compareApply.disabled = !event.target.value;
    });

    compareApply?.addEventListener('click', async () => {
      const carId = compareSelect.value;
      if (!carId) return;
      let otherCar = null;
      try {
        const response = await fetch(`/api/cars/${carId}`);
        if (!response.ok) {
          throw new Error('bad response');
        }
        otherCar = await response.json();
      } catch (error) {
        compareSummary.textContent = 'Unable to load comparison data.';
        closeCompareModal();
        openCompareResultModal();
        return;
      }
      const differences = compareFields
        .map((field) => {
          const currentValue = formatCompareValue(currentCar[field.key]);
          const otherValue = formatCompareValue(otherCar[field.key]);
          if (currentValue === otherValue) return null;
          return {
            label: field.label,
            currentValue,
            otherValue,
          };
        })
        .filter(Boolean);

      compareBody.innerHTML = '';
      if (!differences.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 3;
        cell.textContent = 'No differences found.';
        row.appendChild(cell);
        compareBody.appendChild(row);
        compareSummary.textContent = `Comparing car ${currentCar.id} to ${otherCar.id}.`;
      } else {
        differences.forEach((diff) => {
          const row = document.createElement('tr');
          row.classList.add('compare-diff');
          const labelCell = document.createElement('td');
          labelCell.textContent = diff.label;
          const currentCell = document.createElement('td');
          currentCell.textContent = diff.currentValue;
          const otherCell = document.createElement('td');
          otherCell.textContent = diff.otherValue;
          row.appendChild(labelCell);
          row.appendChild(currentCell);
          row.appendChild(otherCell);
          compareBody.appendChild(row);
        });
        compareSummary.textContent = `Comparing car ${currentCar.id} to ${otherCar.id}. Showing ${differences.length} differences.`;
      }
      closeCompareModal();
      openCompareResultModal();
    });

    document.addEventListener('keydown', (event) => {
      if (compareModal.getAttribute('aria-hidden') === 'true') return;
      if (event.key === 'Escape') {
        event.preventDefault();
        closeCompareModal();
      }
    });
    document.addEventListener('keydown', (event) => {
      if (compareResultModal.getAttribute('aria-hidden') === 'true') return;
      if (event.key === 'Escape') {
        event.preventDefault();
        closeCompareResultModal();
      }
    });
    document.addEventListener('keydown', (event) => {
      if (copyModal.getAttribute('aria-hidden') === 'true') return;
      if (event.key === 'Escape') {
        event.preventDefault();
        closeCopyModal();
      }
    });
  </script>
{% endblock %}
