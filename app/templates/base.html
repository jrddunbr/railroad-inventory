<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Railroad Inventory</title>
  <link rel="stylesheet" href="https://unpkg.com/@cloudscape-design/components@3.0.0/styles.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600&display=swap">
  <style>
    :root {
      --mi-bg: #f5f2ea;
      --mi-ink: #222222;
      --mi-accent: #2d5f5d;
      --mi-panel: #ffffff;
      --mi-border: #d6d1c8;
      --mi-overlay: rgba(34, 34, 34, 0.45);
    }
    body {
      font-family: "IBM Plex Sans", sans-serif;
      background: radial-gradient(circle at top, #fef9f0 0%, var(--mi-bg) 55%, #efe9de 100%);
      color: var(--mi-ink);
      margin: 0;
    }
    header {
      background: var(--mi-panel);
      border-bottom: 1px solid var(--mi-border);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }
    .brand {
      font-size: 20px;
      font-weight: 600;
    }
    .container {
      display: grid;
      grid-template-columns: 220px 1fr;
      min-height: calc(100vh - 64px);
    }
    nav {
      border-right: 1px solid var(--mi-border);
      padding: 16px;
    }
    nav a {
      display: block;
      margin-bottom: 12px;
      color: var(--mi-ink);
      text-decoration: none;
      font-weight: 600;
    }
    nav a.active {
      color: var(--mi-accent);
    }
    main {
      padding: 24px;
    }
    footer {
      border-top: 1px solid var(--mi-border);
      color: #6b7280;
      font-size: 0.85rem;
      padding: 16px 24px;
      text-align: center;
    }
    footer a {
      color: inherit;
      text-decoration: none;
    }
    footer a:hover {
      text-decoration: underline;
    }
    .panel {
      background: var(--mi-panel);
      border: 1px solid var(--mi-border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(34, 34, 34, 0.06);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      text-align: left;
      padding: 8px 10px;
      border-bottom: 1px solid var(--mi-border);
      vertical-align: top;
    }
    input, select, textarea, button {
      font-family: inherit;
      font-size: 14px;
    }
    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    .actions {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 16px;
    }
    .actions form {
      margin: 0;
    }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e8efe8;
      color: #2d5f5d;
      font-size: 12px;
      font-weight: 600;
    }
    .keyboard-hint {
      font-size: 12px;
      color: #666666;
      margin-top: 8px;
    }
    .confirm-overlay {
      position: fixed;
      inset: 0;
      background: var(--mi-overlay);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 1000;
    }
    .confirm-dialog {
      width: min(720px, 92vw);
      background: var(--mi-panel);
      border-radius: 16px;
      border: 1px solid var(--mi-border);
      box-shadow: 0 24px 60px rgba(34, 34, 34, 0.25);
      padding: 20px 24px;
    }
    .confirm-dialog h2 {
      margin-top: 0;
    }
    .confirm-dialog ul {
      padding-left: 18px;
    }
    .confirm-dialog pre {
      background: #f7f3ea;
      border: 1px solid var(--mi-border);
      border-radius: 8px;
      padding: 12px;
      white-space: pre-wrap;
    }
    .confirm-details {
      margin-top: 12px;
    }
    .confirm-toggle {
      background: none;
      border: none;
      color: var(--mi-accent);
      font-weight: 600;
      cursor: pointer;
      padding: 0;
    }
    .confirm-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 16px;
    }
    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
      nav {
        border-right: none;
        border-bottom: 1px solid var(--mi-border);
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      nav a {
        margin-bottom: 0;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">Railroad Inventory</div>
    <div class="actions" style="margin-top: 0;">
      <form method="get" action="{{ url_for('main.search') }}">
        <input name="q" placeholder="Search inventory" value="{{ request.args.get('q', '') }}" />
      </form>
      <a href="{{ url_for('main.car_new') }}" class="tag">Add New</a>
    </div>
  </header>
  <div class="container">
    <nav>
      <a href="{{ url_for('main.inventory') }}" class="{% if request.path == '/inventory' %}active{% endif %}">Inventory</a>
      <a href="{{ url_for('main.railroads') }}" class="{% if request.path == '/railroads' %}active{% endif %}">Railroads</a>
      <a href="{{ url_for('main.locations') }}" class="{% if request.path == '/locations' %}active{% endif %}">Locations</a>
      <a href="{{ url_for('main.car_classes') }}" class="{% if request.path == '/car-classes' %}active{% endif %}">Car Classes</a>
      <a href="{{ url_for('main.locomotive_classes') }}" class="{% if request.path == '/locomotive-classes' %}active{% endif %}">Locomotive Classes</a>
      <a href="{{ url_for('main.loads') }}" class="{% if request.path == '/loads' %}active{% endif %}">Loads</a>
      <a href="{{ url_for('main.tools') }}" class="{% if request.path == '/tools' %}active{% endif %}">Tools</a>
      <a href="{{ url_for('main.search') }}" class="{% if request.path == '/search' %}active{% endif %}">Search</a>
      <a href="{{ url_for('main.reports') }}" class="{% if request.path == '/reports' %}active{% endif %}">Reports</a>
      <a href="{{ url_for('main.settings') }}" class="{% if request.path.startswith('/settings') %}active{% endif %}">Settings</a>
    </nav>
    <main>
      {% block content %}{% endblock %}
    </main>
  </div>
  <footer>
    Copyright Jared Dunbar 2026 Â·
    <a href="https://github.com/jrddunbr/railroad-inventory" target="_blank" rel="noopener">GitHub</a>
  </footer>
  <div id="mi-confirm-modal" class="confirm-overlay" style="display: none;" aria-hidden="true">
    <div class="confirm-dialog" role="dialog" aria-modal="true" aria-labelledby="mi-confirm-title">
      <h2 id="mi-confirm-title">Confirm database change</h2>
      <p class="keyboard-hint" id="mi-confirm-hint">Press Enter to confirm or Esc to cancel.</p>
      <ul id="mi-confirm-summary"></ul>
      <button type="button" class="confirm-toggle" id="mi-confirm-toggle">More details</button>
      <div class="confirm-details" id="mi-confirm-details" hidden>
        <pre id="mi-confirm-payload"></pre>
      </div>
      <div class="confirm-actions">
        <button type="button" id="mi-confirm-cancel">Cancel</button>
        <button type="button" id="mi-confirm-approve">Confirm</button>
      </div>
    </div>
  </div>
  <script>
    const confirmModal = document.getElementById('mi-confirm-modal');
    const confirmSummary = document.getElementById('mi-confirm-summary');
    const confirmToggle = document.getElementById('mi-confirm-toggle');
    const confirmDetails = document.getElementById('mi-confirm-details');
    const confirmPayload = document.getElementById('mi-confirm-payload');
    const confirmApprove = document.getElementById('mi-confirm-approve');
    const confirmCancel = document.getElementById('mi-confirm-cancel');
    const confirmTitle = document.getElementById('mi-confirm-title');
    let activeForm = null;

    const docTypeMap = {
      railroads: 'railroad',
      car_classes: 'car_class',
      locations: 'location',
      cars: 'car',
      loads: 'load',
      load_placements: 'load_placement',
      railroad_color_schemes: 'railroad_color_scheme',
      railroad_logos: 'railroad_logo',
      railroad_slogans: 'railroad_slogan',
      car_inspections: 'car_inspection',
      inspection_types: 'inspection_type',
    };

    const getLabelText = (input) => {
      if (input.dataset.confirmLabel) return input.dataset.confirmLabel;
      if (input.id) {
        const label = document.querySelector(`label[for="${input.id}"]`);
        if (label) return label.textContent.trim();
      }
      return input.name || input.id || 'Field';
    };

    const getSelectDefaultValue = (select) => {
      const option = Array.from(select.options).find((opt) => opt.defaultSelected) || select.options[0];
      return option ? option.value : '';
    };

    const getSelectDisplay = (select, value) => {
      const option = Array.from(select.options).find((opt) => opt.value === value) || select.options[select.selectedIndex];
      if (!option) return value;
      const label = option.textContent.trim();
      if (label && label !== value) {
        return `${label} (${value || '-'})`;
      }
      return value || label || '-';
    };

    const collectChanges = (form) => {
      const fields = [];
      const radiosByName = {};
      const nameCounts = {};
      const elements = Array.from(form.elements || []);
      elements.forEach((input) => {
        if (!input || !input.name) return;
        if (input.disabled) return;
        if (input.type === 'submit' || input.type === 'button') return;
        if (input.type === 'hidden' && !input.dataset.confirmInclude) return;
        if (input.type === 'radio') {
          radiosByName[input.name] = radiosByName[input.name] || [];
          radiosByName[input.name].push(input);
          return;
        }
        let currentValue = '';
        let defaultValue = '';
        let displayValue = '';
        let displayDefault = '';
        let hasValue = false;
        if (input.type === 'checkbox') {
          currentValue = input.checked ? 'checked' : 'unchecked';
          defaultValue = input.defaultChecked ? 'checked' : 'unchecked';
          displayValue = currentValue;
          displayDefault = defaultValue;
          hasValue = input.checked;
        } else if (input.type === 'file') {
          const file = input.files && input.files[0];
          currentValue = file ? file.name : '';
          defaultValue = input.defaultValue || '';
          displayValue = currentValue || '-';
          displayDefault = defaultValue || '-';
          hasValue = !!currentValue;
        } else if (input.tagName === 'SELECT') {
          currentValue = input.value || '';
          defaultValue = getSelectDefaultValue(input);
          displayValue = getSelectDisplay(input, currentValue);
          displayDefault = getSelectDisplay(input, defaultValue);
          hasValue = currentValue !== '';
        } else {
          currentValue = (input.value || '').trim();
          defaultValue = (input.defaultValue || '').trim();
          displayValue = currentValue || '-';
          displayDefault = defaultValue || '-';
          hasValue = currentValue !== '';
        }
        if (input.dataset.isDefault === 'true' && !currentValue) {
          return;
        }
        const label = getLabelText(input);
        nameCounts[label] = (nameCounts[label] || 0) + 1;
        const numberedLabel = nameCounts[label] > 1 ? `${label} (#${nameCounts[label]})` : label;
        fields.push({
          name: input.name,
          label: numberedLabel,
          currentValue,
          defaultValue,
          displayValue,
          displayDefault,
          hasValue,
        });
      });

      Object.entries(radiosByName).forEach(([name, group]) => {
        const current = group.find((radio) => radio.checked);
        const defaults = group.find((radio) => radio.defaultChecked);
        const currentValue = current ? current.value : '';
        const defaultValue = defaults ? defaults.value : '';
        const label = getLabelText(current || group[0]);
        nameCounts[label] = (nameCounts[label] || 0) + 1;
        const numberedLabel = nameCounts[label] > 1 ? `${label} (#${nameCounts[label]})` : label;
        fields.push({
          name,
          label: numberedLabel,
          currentValue,
          defaultValue,
          displayValue: currentValue || '-',
          displayDefault: defaultValue || '-',
          hasValue: currentValue !== '',
        });
      });

      return fields;
    };

    const buildCouchPreview = (form, action, changes) => {
      const table = form.dataset.table;
      if (!table) return '';
      const docType = docTypeMap[table] || table;
      const idValue = form.dataset.id || '';
      const fieldsByName = {};
      changes.forEach((field) => {
        fieldsByName[field.name] = field.currentValue;
      });
      const relatedTables = (form.dataset.relatedTables || '')
        .split(',')
        .map((item) => item.trim())
        .filter(Boolean);
      const payload = {
        operation: action,
        doc_type: docType,
      };
      if (idValue) {
        payload.doc_id = `${docType}:${idValue}`;
      } else if (action !== 'delete') {
        payload.doc_id = '(auto)';
      }
      if (action === 'delete') {
        payload.body = {
          _id: idValue ? `${docType}:${idValue}` : '(auto)',
          _deleted: true,
        };
        return JSON.stringify(payload, null, 2);
      }

      payload.body = {
        type: docType,
        ...fieldsByName,
      };
      if (idValue) {
        payload.body.id = idValue;
      }
      if (!relatedTables.length) return JSON.stringify(payload, null, 2);
      const formData = new FormData(form);
      const relatedConfig = {
        railroad_color_schemes: {
          idField: 'color_scheme_id',
          columns: {
            description: 'color_scheme_description',
            start_date: 'color_scheme_start',
            end_date: 'color_scheme_end',
            colors: 'color_scheme_colors',
          },
        },
        railroad_logos: {
          idField: 'logo_id',
          columns: {
            description: 'logo_description',
            start_date: 'logo_start',
            end_date: 'logo_end',
            image_path: 'logo_existing_path',
          },
        },
        railroad_slogans: {
          idField: 'slogan_id',
          columns: {
            description: 'slogan_description',
            slogan_text: 'slogan_text',
            start_date: 'slogan_start',
            end_date: 'slogan_end',
          },
        },
      };
      const relatedPayloads = {};
      relatedTables.forEach((related) => {
        const relatedType = docTypeMap[related] || related;
        const config = relatedConfig[related];
        if (!config) {
          relatedPayloads[relatedType] = ['(unmapped form fields)'];
          return;
        }
        const fieldNames = Object.values(config.columns);
        const valuesByField = fieldNames.map((name) =>
          formData.getAll(name).map((value) => {
            if (value instanceof File) {
              return value.name || '';
            }
            return String(value || '').trim();
          })
        );
        const idValues = config.idField
          ? formData.getAll(config.idField).map((value) => String(value || '').trim())
          : [];
        const rowCount = Math.max(0, ...valuesByField.map((list) => list.length));
        const rows = [];
        for (let index = 0; index < rowCount; index += 1) {
          const rowValues = valuesByField.map((list) => list[index] || '');
          if (rowValues.every((value) => value === '')) {
            continue;
          }
          const row = {};
          Object.keys(config.columns).forEach((column, idx) => {
            row[column] = rowValues[idx];
          });
          const idValue = idValues[index];
          if (idValue) {
            row.id = idValue;
          }
          rows.push(row);
        }
        if (rows.length) {
          relatedPayloads[relatedType] = rows.map((row) => ({
            type: relatedType,
            ...row,
          }));
        }
      });
      if (Object.keys(relatedPayloads).length) {
        payload.related = relatedPayloads;
      }
      return JSON.stringify(payload, null, 2);
    };

    const openConfirm = (form) => {
      const action = form.dataset.action || (form.dataset.mode === 'edit' || form.dataset.id ? 'update' : 'insert');
      const fields = collectChanges(form);
      const changes = action === 'update'
        ? fields.filter((field) => field.currentValue !== field.defaultValue)
        : fields.filter((field) => field.hasValue);
      confirmSummary.innerHTML = '';
      if (action === 'delete') {
        const label = form.dataset.entityLabel || 'this record';
        const item = document.createElement('li');
        item.textContent = `Delete ${label}.`;
        confirmSummary.appendChild(item);
      } else if (changes.length) {
        changes.forEach((change) => {
          const item = document.createElement('li');
          if (action === 'insert') {
            item.textContent = `${change.label}: ${change.displayValue}`;
          } else {
            item.textContent = `${change.label}: ${change.displayDefault} -> ${change.displayValue}`;
          }
          confirmSummary.appendChild(item);
        });
      } else {
        const item = document.createElement('li');
        item.textContent = 'No field changes detected.';
        confirmSummary.appendChild(item);
      }
      confirmTitle.textContent = action === 'delete' ? 'Confirm deletion' : 'Confirm database change';
      confirmDetails.hidden = true;
      confirmToggle.textContent = 'More details';
      confirmPayload.textContent = buildCouchPreview(form, action, changes);
      confirmModal.style.display = 'flex';
      confirmModal.setAttribute('aria-hidden', 'false');
      confirmApprove.focus();
    };

    const closeConfirm = (clearActive = true) => {
      confirmModal.style.display = 'none';
      confirmModal.setAttribute('aria-hidden', 'true');
      if (clearActive) {
        activeForm = null;
      }
    };

    document.addEventListener('submit', (event) => {
      const form = event.target;
      if (!form || form.tagName !== 'FORM') return;
      if (form.dataset.confirmSkip) return;
      const method = (form.method || '').toLowerCase();
      if (method !== 'post') return;
      if (form.dataset.confirmed === 'true') return;
      event.preventDefault();
      activeForm = form;
      openConfirm(form);
    });

    confirmToggle?.addEventListener('click', () => {
      const nextState = confirmDetails.hidden;
      confirmDetails.hidden = !nextState;
      confirmToggle.textContent = nextState ? 'Hide details' : 'More details';
    });

    confirmApprove?.addEventListener('click', () => {
      if (!activeForm) return;
      const formToSubmit = activeForm;
      formToSubmit.dataset.confirmed = 'true';
      closeConfirm(false);
      formToSubmit.submit();
      activeForm = null;
    });

    confirmCancel?.addEventListener('click', closeConfirm);

    document.addEventListener('keydown', (event) => {
      if (!activeForm || confirmModal.getAttribute('aria-hidden') === 'true') return;
      if (event.key === 'Escape') {
        event.preventDefault();
        closeConfirm();
      }
      if (event.key === 'Enter') {
        event.preventDefault();
        confirmApprove.click();
      }
    });
  </script>
</body>
</html>
